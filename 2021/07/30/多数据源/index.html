<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>多数据源 | 锦瑟流年</title><meta name="keywords" content="多数据源"><meta name="author" content="流年"><meta name="copyright" content="流年"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="基础简介dynamic-datasource-spring-boot-starter 是一个基于springboot的快速集成多数据源的启动器。 其支持 Jdk 1.7+, SpringBoot 1.4.x 1.5.x 2.x.x。 特性 支持 数据源分组 ，适用于多种场景 纯粹多库 读写分离 一主多从 混合模式。 支持数据库敏感配置信息 加密 ENC()。 支持每个数据库独立初始化表结构sche">
<meta property="og:type" content="article">
<meta property="og:title" content="多数据源">
<meta property="og:url" content="http://www.yafeiz.com/2021/07/30/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/index.html">
<meta property="og:site_name" content="锦瑟流年">
<meta property="og:description" content="基础简介dynamic-datasource-spring-boot-starter 是一个基于springboot的快速集成多数据源的启动器。 其支持 Jdk 1.7+, SpringBoot 1.4.x 1.5.x 2.x.x。 特性 支持 数据源分组 ，适用于多种场景 纯粹多库 读写分离 一主多从 混合模式。 支持数据库敏感配置信息 加密 ENC()。 支持每个数据库独立初始化表结构sche">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://www.yafeiz.com/img/index.jpg">
<meta property="article:published_time" content="2021-07-30T13:22:10.000Z">
<meta property="article:modified_time" content="2021-07-30T13:31:49.492Z">
<meta property="article:author" content="流年">
<meta property="article:tag" content="Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://www.yafeiz.com/img/index.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://www.yafeiz.com/2021/07/30/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="google-site-verification" content="CMxvMS0ZaW8zrbI2J4cvLA_L25VR_C5D7QptYsiZgDM"/><meta name="msvalidate.01" content="FBBBB6F1B87A1658DE454375FA55E484"/><meta name="baidu-site-verification" content="code-5pNSXdnIWU"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?4c15d038e8a16434aa82646f62061b34";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-07-30 21:31:49'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
   if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }
  const autoChangeMode = 'true'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified
    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }const asideStatus = saveToLocal.get('aside-status')
if (asideStatus !== undefined) {
   if (asideStatus === 'hide') {
     document.documentElement.classList.add('hide-aside')
   } else {
     document.documentElement.classList.remove('hide-aside')
   }
}})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/index.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">锦瑟流年</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><h1 class="post-title">多数据源</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-07-30T13:22:10.000Z" title="发表于 2021-07-30 21:22:10">2021-07-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-07-30T13:31:49.492Z" title="更新于 2021-07-30 21:31:49">2021-07-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Java/">Java</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>dynamic-datasource-spring-boot-starter 是一个基于springboot的快速集成多数据源的启动器。</p>
<p>其支持 <strong>Jdk 1.7+, SpringBoot 1.4.x 1.5.x 2.x.x</strong>。</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li>支持 <strong>数据源分组</strong> ，适用于多种场景 纯粹多库 读写分离 一主多从 混合模式。</li>
<li>支持数据库敏感配置信息 <strong>加密</strong> ENC()。</li>
<li>支持每个数据库独立初始化表结构schema和数据库database。</li>
<li>支持无数据源启动，支持懒加载数据源（需要的时候再创建连接）。</li>
<li>支持 <strong>自定义注解</strong> ，需继承DS(3.2.0+)。</li>
<li>提供并简化对Druid，HikariCp，BeeCp，Dbcp2的快速集成。</li>
<li>提供对Mybatis-Plus，Quartz，ShardingJdbc，P6sy，Jndi等组件的集成方案。</li>
<li>提供 <strong>自定义数据源来源</strong> 方案（如全从数据库加载）。</li>
<li>提供项目启动后 <strong>动态增加移除数据源</strong> 方案。</li>
<li>提供Mybatis环境下的 <strong>纯读写分离</strong> 方案。</li>
<li>提供使用 <strong>spel动态参数</strong> 解析数据源方案。内置spel，session，header，支持自定义。</li>
<li>支持 <strong>多层数据源嵌套切换</strong> 。（ServiceA &gt;&gt;&gt; ServiceB &gt;&gt;&gt; ServiceC）。</li>
<li>提供 <strong>基于seata的分布式事务方案。</strong></li>
<li>提供 <strong>本地多数据源事务方案。</strong> 附：不能和原生spring事务混用。</li>
</ul>
<h2 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h2><ol>
<li>本框架只做 <strong>切换数据源</strong> 这件核心的事情，并<strong>不限制你的具体操作</strong>，切换了数据源可以做任何CRUD。</li>
<li>配置文件所有以下划线 <code>_</code> 分割的数据源 <strong>首部</strong> 即为组的名称，相同组名称的数据源会放在一个组下。</li>
<li>切换数据源可以是组名，也可以是具体数据源名称。组名则切换时采用负载均衡算法切换。</li>
<li>默认的数据源名称为 <strong>master</strong> ，你可以通过 <code>spring.datasource.dynamic.primary</code> 修改。</li>
<li>方法上的注解优先于类上注解。</li>
<li>DS支持继承抽象类上的DS，暂不支持继承接口上的DS。</li>
</ol>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ol>
<li>引入dynamic-datasource-spring-boot-starter。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ol>
<li>配置数据源。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: master #设置默认的数据源或者数据源组,默认值即为master</span><br><span class="line">      strict: false #严格匹配数据源,默认false. true未匹配到指定数据源时抛异常,false使用默认数据源</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver # 3.2.0开始支持SPI可省略此配置</span><br><span class="line">        slave_1:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3307/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        slave_2:</span><br><span class="line">          url: ENC(xxxxx) # 内置加密,使用请查看详细文档</span><br><span class="line">          username: ENC(xxxxx)</span><br><span class="line">          password: ENC(xxxxx)</span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          </span><br><span class="line">       #......省略</span><br><span class="line">       #以上会配置一个默认库master，一个组slave下有两个子库slave_1,slave_2</span><br><span class="line"># 多主多从                      纯粹多库（记得设置primary）                   混合配置</span><br><span class="line">spring:                               spring:                               spring:</span><br><span class="line">  datasource:                           datasource:                           datasource:</span><br><span class="line">    dynamic:                              dynamic:                              dynamic:</span><br><span class="line">      datasource:                           datasource:                           datasource:</span><br><span class="line">        master_1:                             mysql:                                master:</span><br><span class="line">        master_2:                             oracle:                               slave_1:</span><br><span class="line">        slave_1:                              sqlserver:                            slave_2:</span><br><span class="line">        slave_2:                              postgresql:                           oracle_1:</span><br><span class="line">        slave_3:                              h2:                                   oracle_2:</span><br></pre></td></tr></table></figure>

<ol>
<li>使用 <strong>@DS</strong> 切换数据源。</li>
</ol>
<p><strong>@DS</strong> 可以注解在方法上或类上，<strong>同时存在就近原则 方法上注解 优先于 类上注解</strong>。</p>
<table>
<thead>
<tr>
<th align="center">注解</th>
<th align="center">结果</th>
</tr>
</thead>
<tbody><tr>
<td align="center">没有@DS</td>
<td align="center">默认数据源</td>
</tr>
<tr>
<td align="center">@DS(“dsName”)</td>
<td align="center">dsName可以为组名也可以为具体某个库的名称</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DS(&quot;slave&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  jdbcTemplate.queryForList(<span class="string">&quot;select * from user&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@DS(&quot;slave_1&quot;)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List <span class="title">selectByCondition</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span>  jdbcTemplate.queryForList(<span class="string">&quot;select * from user where age &gt;10&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="连接池集成"><a href="#连接池集成" class="headerlink" title="连接池集成"></a>连接池集成</h1><h2 id="连接池必读"><a href="#连接池必读" class="headerlink" title="连接池必读"></a>连接池必读</h2><ol>
<li>每个数据源都有一个type来指定连接池。</li>
<li>每个数据源甚至可以使用不同的连接池，如无特殊需要并不建议。</li>
<li>type <strong>不是必填字段</strong> ，在没有设置type的时候系统会自动按以下顺序查找并使用连接池。<br>Druid&gt;HikariCp&gt;BeeCp&gt;DBCP2&gt;Spring Basic。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: db1 </span><br><span class="line">      datasource:</span><br><span class="line">        db1:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          type: com.zaxxer.hikari.HikariDataSource #使用Hikaricp</span><br><span class="line">        db2:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3307/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          type: com.alibaba.druid.pool.DruidDataSource #使用Druid</span><br><span class="line">        db3:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3308/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          type: cn.beecp.BeeDataSource #使用beecp</span><br></pre></td></tr></table></figure>

<h2 id="集成Druid"><a href="#集成Druid" class="headerlink" title="集成Druid"></a>集成Druid</h2><h3 id="基础介绍"><a href="#基础介绍" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>Druid Github <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a></li>
<li>Druid 文档 <a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki">https://github.com/alibaba/druid/wiki</a></li>
</ul>
<p>本组件能<code>简单高效</code> 完成对Druid的集成并完成其参数的多元化配置。</p>
<p>1.各个库可以使用不同的数据库连接池，如 <strong>master使用Druid监控，从库使用HikariCP</strong>。<br>2.如果项目同时存在Druid和HikariCP并且未配置连接池type类型，默认 <strong>Druid优先于HikariCP</strong> 。</p>
<h3 id="集成步骤"><a href="#集成步骤" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入-druid-spring-boot-starter-依赖。"><a href="#1-项目引入-druid-spring-boot-starter-依赖。" class="headerlink" title="1. 项目引入 druid-spring-boot-starter 依赖。"></a>1. 项目引入 <code>druid-spring-boot-starter</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/com.alibaba/druid"><img src="https://img.shields.io/maven-central/v/com.alibaba/druid.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-排除原生Druid的快速配置类。"><a href="#2-排除原生Druid的快速配置类。" class="headerlink" title="2. 排除原生Druid的快速配置类。"></a>2. 排除原生Druid的快速配置类。</h4><p>注意：<strong>v3.3.3及以上</strong>版本不用排除了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication(exclude = DruidDataSourceAutoConfigure.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(Application.class, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>某些springBoot的版本上面可能无法排除可用以下方式排除。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  autoconfigure:</span><br><span class="line">    exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span><br></pre></td></tr></table></figure>

<h4 id="3-参数配置。"><a href="#3-参数配置。" class="headerlink" title="3.参数配置。"></a>3.参数配置。</h4><ol>
<li>如果参数都未配置，则保持原组件默认值。</li>
<li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li>
<li>每一个数据源可以单独设置参数覆盖全局参数。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    druid:</span><br><span class="line">      stat-view-servlet:</span><br><span class="line">        enabled: <span class="keyword">true</span></span><br><span class="line">        loginUsername: admin</span><br><span class="line">        loginPassword: <span class="number">123456</span></span><br><span class="line">    dynamic:</span><br><span class="line">      druid: #以下是支持的全局默认值</span><br><span class="line">        initial-size:</span><br><span class="line">        max-active:</span><br><span class="line">        min-idle:</span><br><span class="line">        max-wait:</span><br><span class="line">        time-between-eviction-runs-millis:</span><br><span class="line">        time-between-log-stats-millis:</span><br><span class="line">        stat-sqlmax-size:</span><br><span class="line">        min-evictable-idle-time-millis:</span><br><span class="line">        max-evictable-idle-time-millis:</span><br><span class="line">        test-<span class="keyword">while</span>-idle:</span><br><span class="line">        test-on-borrow:</span><br><span class="line">        test-on-<span class="keyword">return</span>:</span><br><span class="line">        validation-query:</span><br><span class="line">        validation-query-timeout:</span><br><span class="line">        use-global-datasource-stat:</span><br><span class="line">        async-init:</span><br><span class="line">        clear-filters-enable:</span><br><span class="line">        reset-stat-enable:</span><br><span class="line">        not-full-timeout-retry-count:</span><br><span class="line">        max-wait-thread-count:</span><br><span class="line">        fail-fast:</span><br><span class="line">        phyTimeout-millis:</span><br><span class="line">        keep-alive:</span><br><span class="line">        pool-prepared-statements:</span><br><span class="line">        init-variants:</span><br><span class="line">        init-global-variants:</span><br><span class="line">        use-unfair-lock:</span><br><span class="line">        kill-when-socket-read-timeout:</span><br><span class="line">        connection-properties:</span><br><span class="line">        max-pool-prepared-statement-per-connection-size:</span><br><span class="line">        init-connection-sqls:</span><br><span class="line">        share-prepared-statements:</span><br><span class="line">        connection-errorretry-attempts:</span><br><span class="line">        <span class="keyword">break</span>-after-acquire-failure:</span><br><span class="line">        filters: stat # 注意这个值和druid原生不一致，默认启动了stat</span><br><span class="line">        wall:</span><br><span class="line">            noneBaseStatementAllow:</span><br><span class="line">            callAllow:</span><br><span class="line">            selectAllow:</span><br><span class="line">            selectIntoAllow:</span><br><span class="line">            selectIntoOutfileAllow:</span><br><span class="line">            selectWhereAlwayTrueCheck:</span><br><span class="line">            selectHavingAlwayTrueCheck:</span><br><span class="line">            selectUnionCheck:</span><br><span class="line">            selectMinusCheck:</span><br><span class="line">            selectExceptCheck:</span><br><span class="line">            selectIntersectCheck:</span><br><span class="line">            createTableAllow:</span><br><span class="line">            dropTableAllow:</span><br><span class="line">            alterTableAllow:</span><br><span class="line">            renameTableAllow:</span><br><span class="line">            hintAllow:</span><br><span class="line">            lockTableAllow:</span><br><span class="line">            startTransactionAllow:</span><br><span class="line">            blockAllow:</span><br><span class="line">            conditionAndAlwayTrueAllow:</span><br><span class="line">            conditionAndAlwayFalseAllow:</span><br><span class="line">            conditionDoubleConstAllow:</span><br><span class="line">            conditionLikeTrueAllow:</span><br><span class="line">            selectAllColumnAllow:</span><br><span class="line">            deleteAllow:</span><br><span class="line">            deleteWhereAlwayTrueCheck:</span><br><span class="line">            deleteWhereNoneCheck:</span><br><span class="line">            updateAllow:</span><br><span class="line">            updateWhereAlayTrueCheck:</span><br><span class="line">            updateWhereNoneCheck:</span><br><span class="line">            insertAllow:</span><br><span class="line">            mergeAllow:</span><br><span class="line">            minusAllow:</span><br><span class="line">            intersectAllow:</span><br><span class="line">            replaceAllow:</span><br><span class="line">            setAllow:</span><br><span class="line">            commitAllow:</span><br><span class="line">            rollbackAllow:</span><br><span class="line">            useAllow:</span><br><span class="line">            multiStatementAllow:</span><br><span class="line">            truncateAllow:</span><br><span class="line">            commentAllow:</span><br><span class="line">            strictSyntaxCheck:</span><br><span class="line">            constArithmeticAllow:</span><br><span class="line">            limitZeroAllow:</span><br><span class="line">            describeAllow:</span><br><span class="line">            showAllow:</span><br><span class="line">            schemaCheck:</span><br><span class="line">            tableCheck:</span><br><span class="line">            functionCheck:</span><br><span class="line">            objectCheck:</span><br><span class="line">            variantCheck:</span><br><span class="line">            mustParameterized:</span><br><span class="line">            doPrivilegedAllow:</span><br><span class="line">            dir:</span><br><span class="line">            tenantTablePattern:</span><br><span class="line">            tenantColumn:</span><br><span class="line">            wrapAllow:</span><br><span class="line">            metadataAllow:</span><br><span class="line">            conditionOpXorAllow:</span><br><span class="line">            conditionOpBitwseAllow:</span><br><span class="line">            caseConditionConstAllow:</span><br><span class="line">            completeInsertValuesCheck:</span><br><span class="line">            insertValuesCheckSize:</span><br><span class="line">            selectLimit:</span><br><span class="line">        stat:</span><br><span class="line">          merge-sql:</span><br><span class="line">          log-slow-sql:</span><br><span class="line">          slow-sql-millis: </span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          druid: # 以下是独立参数，每个库可以重新设置</span><br><span class="line">            initial-size: <span class="number">20</span></span><br><span class="line">            validation-query: select 1 FROM DUAL #比如oracle就需要重新设置这个</span><br><span class="line">            public-key: #（非全局参数）设置即表示启用加密,底层会自动帮你配置相关的连接参数和filter，推荐使用本项目自带的加密方法。</span><br><span class="line">#           ......</span><br><span class="line"></span><br><span class="line"># 生成 publickey 和密码，推荐使用本项目自带的加密方法。</span><br><span class="line"># java -cp druid-1.1.10.jar com.alibaba.druid.filter.config.ConfigTools youpassword</span><br></pre></td></tr></table></figure>

<p>如上即可配置访问用户和密码，访问 <a target="_blank" rel="noopener" href="http://localhost:8080/druid/index.html">http://localhost:8080/druid/index.html</a> 查看druid监控。</p>
<h3 id="核心源码"><a href="#核心源码" class="headerlink" title="核心源码"></a>核心源码</h3><p><code>Druid数据源创建器</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/DruidDataSourceCreator.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/DruidDataSourceCreator.java</a></p>
<p><code>Druid参数源码</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/druid/DruidConfig.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/druid/DruidConfig.java</a></p>
<p>如有参数缺失可参考源码提交PR。</p>
<h2 id="集成HikariCP"><a href="#集成HikariCP" class="headerlink" title="集成HikariCP"></a>集成HikariCP</h2><h3 id="基础介绍-1"><a href="#基础介绍-1" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>HikariCP Github <a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP">https://github.com/brettwooldridge/HikariCP</a></li>
<li>HikariCP 文档 <a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki">https://github.com/brettwooldridge/HikariCP/wiki</a></li>
</ul>
<h3 id="集成步骤-1"><a href="#集成步骤-1" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入-HikariCP-依赖。"><a href="#1-项目引入-HikariCP-依赖。" class="headerlink" title="1. 项目引入 HikariCP 依赖。"></a>1. 项目引入 <code>HikariCP</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/com.zaxxer/HikariCP"><img src="https://img.shields.io/maven-central/v/com.zaxxer/HikariCP.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p><code>SpringBoot2.x.x</code>默认引入了HikariCP，除非对版本有要求无需再次引入。</p>
<p><code>SpringBoot 1.5.x</code>需手动引入，对应的版本请根据自己环境和HikariCP官方文档自行选择。</p>
<h4 id="2-参数配置。"><a href="#2-参数配置。" class="headerlink" title="2.参数配置。"></a>2.参数配置。</h4><ol>
<li>如果参数都未配置，则保持原组件默认值。</li>
<li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li>
<li>每一个数据源可以单独设置参数覆盖全局参数。</li>
</ol>
<p>特别注意，hikaricp原生设置某些字段名和本组件不一致，本组件是根据参数反射设置，而原生hikaricp字段名称和set名称不一致。 所以大家理解，以本组件字段名称为准。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      hikari:  # 全局hikariCP参数，所有值和默认保持一致。(现已支持的参数如下,不清楚含义不要乱设置)</span><br><span class="line">        catalog:</span><br><span class="line">        connection-timeout:</span><br><span class="line">        validation-timeout:</span><br><span class="line">        idle-timeout:</span><br><span class="line">        leak-detection-threshold:</span><br><span class="line">        max-lifetime:</span><br><span class="line">        max-pool-size:</span><br><span class="line">        min-idle:</span><br><span class="line">        initialization-fail-timeout:</span><br><span class="line">        connection-init-sql:</span><br><span class="line">        connection-test-query:</span><br><span class="line">        dataSource-class-name:</span><br><span class="line">        dataSource-jndi-name:</span><br><span class="line">        schema:</span><br><span class="line">        transaction-isolation-name:</span><br><span class="line">        is-auto-commit:</span><br><span class="line">        is-read-only:</span><br><span class="line">        is-isolate-internal-queries:</span><br><span class="line">        is-register-mbeans:</span><br><span class="line">        is-allow-pool-suspension:</span><br><span class="line">        data-source-properties: </span><br><span class="line">        health-check-properties:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          hikari: # 以下参数针对每个库可以重新设置hikari参数</span><br><span class="line">            max-pool-size:</span><br><span class="line">            idle-timeout:</span><br><span class="line">#           ......</span><br></pre></td></tr></table></figure>

<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><p>Failed to validate connection com.mysql.jdbc.JDBC4Connection@xxxxx (No operations allowed after connection closed.)<br><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/issues/1034">https://github.com/brettwooldridge/HikariCP/issues/1034</a></p>
<p>核心意思就是HikariCP要设置 connection-test-query 并且max-lifetime要小于mysql的默认时间。</p>
<h3 id="核心源码-1"><a href="#核心源码-1" class="headerlink" title="核心源码"></a>核心源码</h3><p><code>HikariCP数据源创建器</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/HikariDataSourceCreator.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/HikariDataSourceCreator.java</a></p>
<p><code>HikariCP参数配置类</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/hikari/HikariCpConfig.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/hikari/HikariCpConfig.java</a></p>
<h2 id="集成BeeCP"><a href="#集成BeeCP" class="headerlink" title="集成BeeCP"></a>集成BeeCP</h2><h3 id="基础介绍-2"><a href="#基础介绍-2" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>BeeCp Github <a target="_blank" rel="noopener" href="https://github.com/Chris2018998/BeeCP">https://github.com/Chris2018998/BeeCP</a></li>
<li>BeeCp 文档 <a target="_blank" rel="noopener" href="https://github.com/Chris2018998/BeeCP/blob/master/README_ZH.md">https://github.com/Chris2018998/BeeCP/blob/master/README_ZH.md</a></li>
</ul>
<h3 id="集成步骤-2"><a href="#集成步骤-2" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入-BeeCp-依赖。"><a href="#1-项目引入-BeeCp-依赖。" class="headerlink" title="1. 项目引入 BeeCp 依赖。"></a>1. 项目引入 <code>BeeCp</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/com.github.chris2018998/beecp"><img src="https://img.shields.io/maven-central/v/com.github.chris2018998/beecp.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.github.chris2018998&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;beecp&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-参数配置。-1"><a href="#2-参数配置。-1" class="headerlink" title="2.参数配置。"></a>2.参数配置。</h4><ol>
<li>如果参数都未配置，则保持原组件默认值。</li>
<li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li>
<li>每一个数据源可以单独设置参数覆盖全局参数。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      beecp:  # 全局beeCp参数，所有值和默认保持一致。(现已支持的参数如下,不清楚含义不要乱设置)</span><br><span class="line">        <span class="keyword">default</span>-catalog:</span><br><span class="line">        <span class="keyword">default</span>-schema:</span><br><span class="line">        <span class="keyword">default</span>-readOnly:</span><br><span class="line">        <span class="keyword">default</span>-auto-commit:</span><br><span class="line">        <span class="keyword">default</span>-transaction-isolation-code:</span><br><span class="line">        <span class="keyword">default</span>-transaction-isolation-name:</span><br><span class="line">        fair-mode:</span><br><span class="line">        initial-size:</span><br><span class="line">        max-active:</span><br><span class="line">        borrow-semaphore-size:</span><br><span class="line">        max-wait:</span><br><span class="line">        idle-timeout:</span><br><span class="line">        hold-timeout:</span><br><span class="line">        connection-test-sql:</span><br><span class="line">        connection-test-timeout:</span><br><span class="line">        connection-test-integererval:</span><br><span class="line">        idle-check-time-integererval:</span><br><span class="line">        force-close-using-on-clear:</span><br><span class="line">        delay-time-<span class="keyword">for</span>-next-clear:</span><br><span class="line">        connection-factory-class-name:</span><br><span class="line">        xa-connection-factory-class-name:</span><br><span class="line">        pool-implement-class-name:</span><br><span class="line">        enable-jmx:</span><br><span class="line">        connect-properties:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          beecp: # 以下参数针对每个库可以重新设置beeCp参数</span><br><span class="line">            initial-size:</span><br><span class="line">            max-active:</span><br><span class="line">#           ......</span><br></pre></td></tr></table></figure>

<h3 id="核心源码-2"><a href="#核心源码-2" class="headerlink" title="核心源码"></a>核心源码</h3><p><code>BeeCp数据源创建器</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/BeeCpDataSourceCreator.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/BeeCpDataSourceCreator.java</a></p>
<p><code>BeeCp参数配置类</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/beecp/BeeCpConfig.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/beecp/BeeCpConfig.java</a></p>
<h2 id="集成DBCP2"><a href="#集成DBCP2" class="headerlink" title="集成DBCP2"></a>集成DBCP2</h2><h3 id="基础介绍-3"><a href="#基础介绍-3" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>Dbcp2 Github <a target="_blank" rel="noopener" href="https://github.com/apache/commons-dbcp">https://github.com/apache/commons-dbcp</a></li>
<li>Dbcp2 文档 <a target="_blank" rel="noopener" href="https://commons.apache.org/proper/commons-dbcp/">https://commons.apache.org/proper/commons-dbcp/</a></li>
</ul>
<h3 id="集成步骤-3"><a href="#集成步骤-3" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入-Dbcp2-依赖。"><a href="#1-项目引入-Dbcp2-依赖。" class="headerlink" title="1. 项目引入 Dbcp2 依赖。"></a>1. 项目引入 <code>Dbcp2</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/org.apache.commons/commons-dbcp2"><img src="https://img.shields.io/maven-central/v/org.apache.commons/commons-dbcp2.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;commons-dbcp2&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-参数配置。-2"><a href="#2-参数配置。-2" class="headerlink" title="2.参数配置。"></a>2.参数配置。</h4><ol>
<li>如果参数都未配置，则保持原组件默认值。</li>
<li>如果配置了全局参数，则每一个数据源都会继承对应参数。</li>
<li>每一个数据源可以单独设置参数覆盖全局参数。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      dbcp2:  # 全局dbcp2参数，所有值和默认保持一致。(现已支持的参数如下,不清楚含义不要乱设置)</span><br><span class="line">        initial-size:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">          dbcp2: # 以下参数针对每个库可以重新设置dbcp2参数</span><br><span class="line">            initial-size:</span><br><span class="line">#           ......</span><br></pre></td></tr></table></figure>

<h3 id="核心源码-3"><a href="#核心源码-3" class="headerlink" title="核心源码"></a>核心源码</h3><p><code>dbcp2数据源创建器</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/Dbcp2DataSourceCreator.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/creator/Dbcp2DataSourceCreator.java</a></p>
<p><code>dbcp2参数配置类</code><a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/dbcp2/Dbcp2Config.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/spring/boot/autoconfigure/dbcp2/Dbcp2Config.java</a></p>
<h2 id="集成Jndi"><a href="#集成Jndi" class="headerlink" title="集成Jndi"></a>集成Jndi</h2><p>JNDI是什么？ <a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaosg198312/article/details/3979435">https://blog.csdn.net/zhaosg198312/article/details/3979435</a></p>
<p>用到JNDI大部分应该是老项目了。 如无需求不建议继续使用JNDI数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      datasource:</span><br><span class="line">          db1:</span><br><span class="line">            jndi_name: xxx</span><br><span class="line">          db2:</span><br><span class="line">            jndi_name: xxx</span><br></pre></td></tr></table></figure>

<h1 id="第三方集成"><a href="#第三方集成" class="headerlink" title="第三方集成"></a>第三方集成</h1><p>通过本章您可以掌握数据源在集成MybatisPlus，Quartz，ShardingJdbc的方案。</p>
<h2 id="集成MybatisPlus"><a href="#集成MybatisPlus" class="headerlink" title="集成MybatisPlus"></a>集成MybatisPlus</h2><h3 id="基础介绍-4"><a href="#基础介绍-4" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>MybatisPlus Github <a target="_blank" rel="noopener" href="https://github.com/baomidou/mybatis-plus">https://github.com/baomidou/mybatis-plus</a></li>
<li>MybatisPlus 文档 <a target="_blank" rel="noopener" href="https://mybatis.plus/">https://mybatis.plus/</a></li>
</ul>
<blockquote>
<p>只要引入了mybatisPlus相关jar包，项目自动集成，兼容mybatisPlus 2.x和3.x的版本。</p>
</blockquote>
<h3 id="集成步骤-4"><a href="#集成步骤-4" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入-mybatis-Plus-依赖。"><a href="#1-项目引入-mybatis-Plus-依赖。" class="headerlink" title="1. 项目引入 mybatis-Plus 依赖。"></a>1. 项目引入 <code>mybatis-Plus</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/com.baomidou/mybatis-plus"><img src="https://img.shields.io/maven-central/v/com.baomidou/mybatis-plus.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-使用DS注解进行切换数据源。"><a href="#2-使用DS注解进行切换数据源。" class="headerlink" title="2. 使用DS注解进行切换数据源。"></a>2. 使用<code>DS</code>注解进行切换数据源。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@DS(&quot;mysql&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>, <span class="title">User</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;oracle&quot;)</span></span><br><span class="line">    <span class="function">publid <span class="keyword">void</span> <span class="title">addUser</span><span class="params">(User user)</span></span>&#123;</span><br><span class="line">        <span class="comment">//do something</span></span><br><span class="line">        baseMapper.insert(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-分页配置。"><a href="#3-分页配置。" class="headerlink" title="3.分页配置。"></a>3.分页配置。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MybatisPlusInterceptor <span class="title">mybatisPlusInterceptor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    MybatisPlusInterceptor interceptor = <span class="keyword">new</span> MybatisPlusInterceptor();</span><br><span class="line">    <span class="comment">//如果是不同类型的库，请不要指定DbType，其会自动判断。</span></span><br><span class="line">    interceptor.addInnerInterceptor(<span class="keyword">new</span> PaginationInnerInterceptor());</span><br><span class="line">   <span class="comment">// interceptor.addInnerInterceptor(new PaginationInnerInterceptor(DbType.MYSQL));</span></span><br><span class="line">    <span class="keyword">return</span> interceptor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-注意事项。"><a href="#4-注意事项。" class="headerlink" title="4.注意事项。"></a>4.注意事项。</h4><p>mp内置的ServiceImpl在新增,更改,删除等一些方法上自带事物导致不能切换数据源。</p>
<p><strong>解决办法:</strong></p>
<ol>
<li>继承ServiceImpl写自己的MyServiceImpl方法，并去掉所有事务。</li>
<li>创建一个新方法，并在此方法上加DS注解. 如上面的<code>addUser</code>方法。</li>
</ol>
<h3 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h3><p><strong>为什么要单独拿出来说和mybatisPlus的集成</strong>？</p>
<p>因为mybatisPlus重写了一些核心类，必须通过解析获得真实的代理对象。</p>
<p>如果自己写多数据源，则很难完成与mp的集成。</p>
<p>核心解析源码 <a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/support/DataSourceClassResolver.java">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/blob/master/src/main/java/com/baomidou/dynamic/datasource/support/DataSourceClassResolver.java</a></p>
<h3 id="示例项目"><a href="#示例项目" class="headerlink" title="示例项目"></a>示例项目</h3><p><a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/mybatisplus3-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/mybatisplus3-sample</a></p>
<h2 id="集成P6spy"><a href="#集成P6spy" class="headerlink" title="集成P6spy"></a>集成P6spy</h2><h3 id="基础介绍-5"><a href="#基础介绍-5" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>P6spy Github <a target="_blank" rel="noopener" href="https://github.com/p6spy/p6spy">https://github.com/p6spy/p6spy</a></li>
<li>P6spy 文档 <a target="_blank" rel="noopener" href="https://p6spy.readthedocs.io/en/latest/">https://p6spy.readthedocs.io/en/latest/</a></li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment"># before</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age&gt;?</span><br><span class="line"><span class="comment"># after enabled p6spy</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> age&gt;<span class="number">6</span></span><br></pre></td></tr></table></figure>

<h3 id="集成步骤-5"><a href="#集成步骤-5" class="headerlink" title="集成步骤"></a>集成步骤</h3><h4 id="1-项目引入p6spy依赖。"><a href="#1-项目引入p6spy依赖。" class="headerlink" title="1. 项目引入p6spy依赖。"></a>1. 项目引入<code>p6spy</code>依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/p6spy/p6spy"><img src="https://img.shields.io/maven-central/v/p6spy/p6spy.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;p6spy&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;p6spy&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-启用p6spy相关配置。"><a href="#2-启用p6spy相关配置。" class="headerlink" title="2. 启用p6spy相关配置。"></a>2. 启用p6spy相关配置。</h4><figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      p6spy: true # 默认false,建议线上关闭。</span><br><span class="line">      datasource:</span><br><span class="line">        product:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">          p6spy: false # 如果这个库不需要可单独关闭。</span><br><span class="line">        order:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br></pre></td></tr></table></figure>

<h4 id="3-引入相关配置文件。"><a href="#3-引入相关配置文件。" class="headerlink" title="3. 引入相关配置文件。"></a>3. 引入相关配置文件。</h4><p>在classPath下创建spy.properties</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"># 一个最简单配置,定义slf4j日志输出。 更多参数请自行了解。</span><br><span class="line">appender=com.p6spy.engine.spy.appender.Slf4JLogger</span><br></pre></td></tr></table></figure>

<h2 id="集成Quartz"><a href="#集成Quartz" class="headerlink" title="集成Quartz"></a>集成Quartz</h2><h3 id="基础介绍-6"><a href="#基础介绍-6" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>Quartz Github <a target="_blank" rel="noopener" href="https://github.com/quartz-scheduler/quartz">https://github.com/quartz-scheduler/quartz</a></li>
<li>Quartz 文档 <a target="_blank" rel="noopener" href="http://www.quartz-scheduler.org/">http://www.quartz-scheduler.org/</a></li>
</ul>
<hr>
<p>Quartz是一个定时任务框架，常常用于解决分布式系统下的定时任务协调问题。</p>
<p>Quartz常常需要独立运行在主业务数据库外,在springboot场景中可以以下面方式运行。</p>
<h3 id="使用方法-1"><a href="#使用方法-1" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="1-项目引用-quartz-starter-。"><a href="#1-项目引用-quartz-starter-。" class="headerlink" title="1. 项目引用 quartz-starter 。"></a>1. 项目引用 <code>quartz-starter</code> 。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/org.quartz-scheduler/quartz"><img src="https://img.shields.io/maven-central/v/org.quartz-scheduler/quartz.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-quartz&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-配置数据源参数。"><a href="#2-配置数据源参数。" class="headerlink" title="2. 配置数据源参数。"></a>2. 配置数据源参数。</h4><p>根据需要可配置独立数据源的参数，或把quartz数据源也作为动态数据源的一个数据源。</p>
<p>一般来说二种方式根据需要选择一种即可，如果没有在动态数据源里需要切到quartz的的场景，建议久独立配吧。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource: #独立quartz配置</span><br><span class="line">    username: root</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/quartz</span></span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">    dynamic:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">        quartz:  #把quartz数据源也作为动态数据源的一个数据源</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/quartz</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">  quartz:</span><br><span class="line">    job-store-type: jdbc</span><br><span class="line">    jdbc:</span><br><span class="line">      initialize-schema: always</span><br></pre></td></tr></table></figure>

<h4 id="3-创建任务。"><a href="#3-创建任务。" class="headerlink" title="3. 创建任务。"></a>3. 创建任务。</h4><p>创建一个每秒打印一次hello world的任务。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloworldJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> time = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Hello world!:&quot;</span> + jobExecutionContext.getJobDetail().getKey() + <span class="string">&quot;-&quot;</span> + (time++));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的自动配置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzCommonAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JobDetail <span class="title">job</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JobBuilder.newJob(HelloworldJob.class)</span><br><span class="line">                .withIdentity(<span class="string">&quot;myJob1&quot;</span>, <span class="string">&quot;myJobGroup1&quot;</span>)</span><br><span class="line">                <span class="comment">//JobDataMap可以给任务execute传递参数</span></span><br><span class="line">                .usingJobData(<span class="string">&quot;job_param&quot;</span>, <span class="string">&quot;job_param1&quot;</span>)</span><br><span class="line">                .storeDurably()</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Trigger <span class="title">myTrigger</span><span class="params">(JobDetail jobDetail)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> TriggerBuilder.newTrigger()</span><br><span class="line">                .forJob(jobDetail)</span><br><span class="line">                .withIdentity(<span class="string">&quot;myTrigger1&quot;</span>, <span class="string">&quot;myTriggerGroup1&quot;</span>)</span><br><span class="line">                .usingJobData(<span class="string">&quot;job_trigger_param&quot;</span>, <span class="string">&quot;job_trigger_param1&quot;</span>)</span><br><span class="line">                .startNow()</span><br><span class="line">                .withSchedule(CronScheduleBuilder.cronSchedule(<span class="string">&quot;0/1 * * * * ? *&quot;</span>))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-配置Quartz实际使用的数据源。"><a href="#4-配置Quartz实际使用的数据源。" class="headerlink" title="4 配置Quartz实际使用的数据源。"></a>4 配置Quartz实际使用的数据源。</h4><p>具体方式有二种，随意选择一种即可。建议方式一，简单点。</p>
<h5 id="4-1-方式一：-自定义SchedulerFactoryBeanCustomizer。"><a href="#4-1-方式一：-自定义SchedulerFactoryBeanCustomizer。" class="headerlink" title="4.1 方式一： 自定义SchedulerFactoryBeanCustomizer。"></a>4.1 方式一： 自定义SchedulerFactoryBeanCustomizer。</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource: #独立quartz配置</span><br><span class="line">    username: root</span><br><span class="line">    password: <span class="number">123456</span></span><br><span class="line">    url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/quartz</span></span><br><span class="line">    driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyQuartzAutoConfigurationMode1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSourceProperties dataSourceProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Order(1)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SchedulerFactoryBeanCustomizer <span class="title">schedulerFactoryBeanCustomizer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DataSource dataSource = dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">        <span class="keyword">return</span> schedulerFactoryBean -&gt; &#123;</span><br><span class="line">            schedulerFactoryBean.setDataSource(dataSource);</span><br><span class="line">            schedulerFactoryBean.setTransactionManager(<span class="keyword">new</span> DataSourceTransactionManager(dataSource));</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果需要使用动态数据源里的某个数据源则打开以下配置，关闭上面配置。</span></span><br><span class="line"><span class="comment">//    @Order(1)</span></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public SchedulerFactoryBeanCustomizer schedulerFactoryBeanCustomizer(DataSource dataSource) &#123;</span></span><br><span class="line"><span class="comment">//        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span></span><br><span class="line"><span class="comment">//        DataSource quartz = ds.getDataSource(&quot;quartz&quot;);</span></span><br><span class="line"><span class="comment">//        return schedulerFactoryBean -&gt; &#123;</span></span><br><span class="line"><span class="comment">//            schedulerFactoryBean.setDataSource(quartz);</span></span><br><span class="line"><span class="comment">//            schedulerFactoryBean.setTransactionManager(new DataSourceTransactionManager(quartz));</span></span><br><span class="line"><span class="comment">//        &#125;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="4-2-方式二：-使用-QuartzDataSource来指明quartz数据源。"><a href="#4-2-方式二：-使用-QuartzDataSource来指明quartz数据源。" class="headerlink" title="4.2 方式二： 使用@QuartzDataSource来指明quartz数据源。"></a>4.2 方式二： 使用@QuartzDataSource来指明quartz数据源。</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyQuartzAutoConfigurationMode2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSourceProperties dataSourceProperties;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.4.0版本及以上使用以下方式注入,老版本请阅读文档  进阶-手动注入多数据源</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DynamicRoutingDataSource dataSource = <span class="keyword">new</span> DynamicRoutingDataSource();</span><br><span class="line">        dataSource.setPrimary(properties.getPrimary());</span><br><span class="line">        dataSource.setStrict(properties.getStrict());</span><br><span class="line">        dataSource.setStrategy(properties.getStrategy());</span><br><span class="line">        dataSource.setP6spy(properties.getP6spy());</span><br><span class="line">        dataSource.setSeata(properties.getSeata());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@QuartzDataSource</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">quartzDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataSourceProperties.initializeDataSourceBuilder().build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果需要使用动态数据源里的某个数据源则打开以下配置，关闭上面配置。</span></span><br><span class="line"><span class="comment">//    @QuartzDataSource</span></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public DataSource quartzDataSource(DataSource dataSource) &#123;</span></span><br><span class="line"><span class="comment">//        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span></span><br><span class="line"><span class="comment">//        return ds.getDataSource(&quot;quartz&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例项目-1"><a href="#示例项目-1" class="headerlink" title="示例项目"></a>示例项目</h3><p><a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/quartz-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/quartz-sample</a></p>
<h2 id="集成ShardingJdbc"><a href="#集成ShardingJdbc" class="headerlink" title="集成ShardingJdbc"></a>集成ShardingJdbc</h2><h3 id="基础介绍-7"><a href="#基础介绍-7" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>shardingsphere Github <a target="_blank" rel="noopener" href="https://github.com/apache/shardingsphere">https://github.com/apache/shardingsphere</a></li>
<li>shardingsphere 文档 <a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/">https://shardingsphere.apache.org/</a></li>
<li>shardingsphere 示例 <a target="_blank" rel="noopener" href="https://github.com/apache/shardingsphere/tree/master/examples">https://github.com/apache/shardingsphere/tree/master/examples</a></li>
</ul>
<hr>
<p>多数据源与shardingsphere集成的场景：部分表比较大需要分表由shardingsphere完成，同时又有多库的需求。</p>
<p>可参考文章 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/166105923">https://zhuanlan.zhihu.com/p/166105923</a></p>
<h3 id="使用方法-2"><a href="#使用方法-2" class="headerlink" title="使用方法"></a>使用方法</h3><h4 id="1-项目引入-shardingsphere-依赖。"><a href="#1-项目引入-shardingsphere-依赖。" class="headerlink" title="1. 项目引入 shardingsphere 依赖。"></a>1. 项目引入 <code>shardingsphere</code> 依赖。</h4><p><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/org.apache.shardingsphere/sharding-jdbc-spring-boot-starter"><img src="https://img.shields.io/maven-central/v/org.apache.shardingsphere/sharding-jdbc-spring-boot-starter.svg" alt="img"></a></p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sharding-jdbc-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.shardingsphere&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sharding-jdbc-spring-namespace&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;$&#123;version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-分别配置shardingjdbc和多数据源。"><a href="#2-分别配置shardingjdbc和多数据源。" class="headerlink" title="2. 分别配置shardingjdbc和多数据源。"></a>2. 分别配置shardingjdbc和多数据源。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  # shardingjdbc 配置</span><br><span class="line">  shardingsphere:</span><br><span class="line">    datasource:</span><br><span class="line">      names: shardingmaster,shardingslave0,shardingslave1</span><br><span class="line">      shardingmaster:</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: org.h2.Driver</span><br><span class="line">        jdbc-url: jdbc:h2:mem:test</span><br><span class="line">        username: sa</span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">      shardingslave0:</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: org.h2.Driver</span><br><span class="line">        jdbc-url: jdbc:h2:mem:test</span><br><span class="line">        username: sa</span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">      shardingslave1:</span><br><span class="line">        type: com.zaxxer.hikari.HikariDataSource</span><br><span class="line">        driver-class-name: org.h2.Driver</span><br><span class="line">        jdbc-url: jdbc:h2:mem:test</span><br><span class="line">        username: sa</span><br><span class="line">        password: <span class="string">&quot;&quot;</span></span><br><span class="line">    masterslave:</span><br><span class="line">      name: ms</span><br><span class="line">      load-balance-algorithm-type: round_robin</span><br><span class="line">      master-data-source-name: shardingmaster</span><br><span class="line">      slave-data-source-names: shardingslave0,shardingslave1</span><br><span class="line">    sharding:</span><br><span class="line">      tables:</span><br><span class="line">        t_order:</span><br><span class="line">          actualDataNodes: shardingmaster.t_order$&#123;<span class="number">0.</span><span class="number">.1</span>&#125;</span><br><span class="line">          tableStrategy:</span><br><span class="line">            inline:</span><br><span class="line">              shardingColumn: order_id</span><br><span class="line">              algorithmExpression: t_order$&#123;order_id % <span class="number">2</span>&#125;</span><br><span class="line">          keyGenerator:</span><br><span class="line">            type: SNOWFLAKE</span><br><span class="line">            column: order_id</span><br><span class="line">  # 动态数据源配置</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:master</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">          schema: db/schema.sql</span><br><span class="line">        test:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">          schema: db/schema.sql</span><br></pre></td></tr></table></figure>

<h4 id="3-通过自定义DynamicDataSourceProvider完成与shardingsphere的集成。"><a href="#3-通过自定义DynamicDataSourceProvider完成与shardingsphere的集成。" class="headerlink" title="3. 通过自定义DynamicDataSourceProvider完成与shardingsphere的集成。"></a>3. 通过自定义DynamicDataSourceProvider完成与shardingsphere的集成。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDataSourceConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DynamicDataSourceProperties properties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 未使用分片, 脱敏的名称(默认): shardingDataSource</span></span><br><span class="line"><span class="comment">     * 使用了主从: masterSlaveDataSource</span></span><br><span class="line"><span class="comment">     * 根据自己场景修改注入</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Resource(name = &quot;masterSlaveDataSource&quot;)</span></span><br><span class="line">    <span class="meta">@Lazy</span>  <span class="comment">//特别注意，有的spring版本不用加Lazy一样能注入，有的会空指针。 根据自己测试选择，但是如果加了lazy就没强转了，也就无法添加其内部的数据源了。  有办法请联系作者。</span></span><br><span class="line">    <span class="keyword">private</span> DataSource masterSlaveDataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DynamicDataSourceProvider <span class="title">dynamicDataSourceProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbstractDataSourceProvider() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Map&lt;String, DataSource&gt; <span class="title">loadDataSources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                dataSourceMap.put(<span class="string">&quot;sharding&quot;</span>, masterSlaveDataSource);</span><br><span class="line">                <span class="comment">//打开下面的代码可以把 shardingJdbc 内部管理的子数据源也同时添加到动态数据源里 (根据自己需要选择开启)</span></span><br><span class="line"><span class="comment">//                dataSourceMap.putAll(((MasterSlaveDataSource) masterSlaveDataSource).getDataSourceMap());</span></span><br><span class="line">                <span class="keyword">return</span> dataSourceMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将动态数据源设置为首选的</span></span><br><span class="line"><span class="comment">     * 当spring存在多个数据源时, 自动注入的是首选的对象</span></span><br><span class="line"><span class="comment">     * 设置为主要的数据源之后，就可以支持shardingjdbc原生的配置方式了</span></span><br><span class="line"><span class="comment">     * 3.4.0版本及以上使用以下方式注入,老版本请阅读文档  进阶-手动注入多数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123; </span><br><span class="line">        DynamicRoutingDataSource dataSource = <span class="keyword">new</span> DynamicRoutingDataSource();</span><br><span class="line">        dataSource.setPrimary(properties.getPrimary());</span><br><span class="line">        dataSource.setStrict(properties.getStrict());</span><br><span class="line">        dataSource.setStrategy(properties.getStrategy());</span><br><span class="line">        dataSource.setP6spy(properties.getP6spy());</span><br><span class="line">        dataSource.setSeata(properties.getSeata());</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例项目-2"><a href="#示例项目-2" class="headerlink" title="示例项目"></a>示例项目</h3><p><a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/sharding-jdbc-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/sharding-jdbc-sample</a></p>
<h1 id="进阶使用"><a href="#进阶使用" class="headerlink" title="进阶使用"></a>进阶使用</h1><p><strong>动态添加移除数据源</strong>：指在系统运行过程中动态的添加数据源，删除数据源，多使用于基于数据库的多租户系统。</p>
<hr>
<p><strong>动态解析数据源</strong>：指数据源切换是不固定的，可以根据域名，根据header参数，根据session参数，根据方法变量等来动态切换。 多使用于多租户系统，支持扩展。</p>
<hr>
<p><strong>数据库加密</strong>：指数据库的url,username,password需要加密，长用于安全性较高系统，不让普通开发通过配置知道生产库的连接配置。</p>
<hr>
<p><strong>启动初始化脚本</strong>：指数据源启动的时候可以执行schema和data的脚本来初始化结构和数据，本组件支持每个数据源加载不同的schema和data。</p>
<hr>
<p><strong>自动读写分离</strong>：适用于mybatis环境，基于mybatis插件实现无注解自动读写分离。</p>
<hr>
<p><strong>懒启动数据源</strong>：指配置的数据源不立即启动，等需要建立连接的时候再真正初始化连接池。</p>
<hr>
<p><strong>无数据源启动</strong>：指启动的时候不配置任何数据源，全靠后期系统动态添加。</p>
<hr>
<p><strong>手动切换数据源</strong>：指某些情况无法根据注解切换，通过工具类手动切换数据源。</p>
<h2 id="动态添加移除数据源"><a href="#动态添加移除数据源" class="headerlink" title="动态添加移除数据源"></a>动态添加移除数据源</h2><h3 id="基础介绍-8"><a href="#基础介绍-8" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>主要在多租户场景中，常常新的一个租户进来需要动态的添加一个数据源到库中，使得系统不用重启即可切换数据源。</p>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.DynamicRoutingDataSource;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.creator.*;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.spring.boot.autoconfigure.DataSourceProperty;</span><br><span class="line"><span class="keyword">import</span> com.baomidou.samples.ds.dto.DataSourceDTO;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.Api;</span><br><span class="line"><span class="keyword">import</span> io.swagger.annotations.ApiOperation;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeanUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.validation.annotation.Validated;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/datasources&quot;)</span></span><br><span class="line"><span class="meta">@Api(tags = &quot;添加删除数据源&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">   <span class="comment">// private final DataSourceCreator dataSourceCreator; //3.3.1及以下版本使用这个通用</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DefaultDataSourceCreator dataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BasicDataSourceCreator basicDataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JndiDataSourceCreator jndiDataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DruidDataSourceCreator druidDataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HikariDataSourceCreator hikariDataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BeeCpDataSourceCreator beeCpDataSourceCreator;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dbcp2DataSourceCreator dbcp2DataSourceCreator;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取当前所有数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">now</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通用数据源会根据maven中配置的连接池根据顺序依次选择。</span></span><br><span class="line">    <span class="comment">//默认的顺序为druid&gt;hikaricp&gt;beecp&gt;dbcp&gt;spring basic</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/add&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;通用添加数据源（推荐）&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">add</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = dataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addBasic(强烈不推荐，除了用了马上移除)&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(value = &quot;添加基础数据源&quot;, notes = &quot;调用Springboot内置方法创建数据源，兼容1,2&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addBasic</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = basicDataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addJndi&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;添加JNDI数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addJndi</span><span class="params">(String pollName, String jndiName)</span> </span>&#123;</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = jndiDataSourceCreator.createDataSource(jndiName);</span><br><span class="line">        ds.addDataSource(pollName, dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addDruid&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;基础Druid数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addDruid</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        dataSourceProperty.setLazy(<span class="keyword">true</span>);</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = druidDataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addHikariCP&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;基础HikariCP数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addHikariCP</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        dataSourceProperty.setLazy(<span class="keyword">true</span>);<span class="comment">//3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span></span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = hikariDataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addBeeCp&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;基础BeeCp数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addBeeCp</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        dataSourceProperty.setLazy(<span class="keyword">true</span>);<span class="comment">//3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span></span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = beeCpDataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/addDbcp&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;基础Dbcp数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">addDbcp</span><span class="params">(<span class="meta">@Validated</span> <span class="meta">@RequestBody</span> DataSourceDTO dto)</span> </span>&#123;</span><br><span class="line">        DataSourceProperty dataSourceProperty = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">        BeanUtils.copyProperties(dto, dataSourceProperty);</span><br><span class="line">        dataSourceProperty.setLazy(<span class="keyword">true</span>);<span class="comment">//3.4.0版本以下如果有此属性，需手动设置，不然会空指针。</span></span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        DataSource dataSource = dbcp2DataSourceCreator.createDataSource(dataSourceProperty);</span><br><span class="line">        ds.addDataSource(dto.getPollName(), dataSource);</span><br><span class="line">        <span class="keyword">return</span> ds.getCurrentDataSources().keySet();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;删除数据源&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">remove</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">        ds.removeDataSource(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;删除成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="示例项目-3"><a href="#示例项目-3" class="headerlink" title="示例项目"></a>示例项目</h3><p><a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/add-remove-datasource-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/add-remove-datasource-sample</a></p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://www.kancloud.cn/tracy5546/dynamic-datasource/images/screenshot_1620832554404.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataSourceCreator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过属性创建数据源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSourceProperty 数据源属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 被创建的数据源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">DataSource <span class="title">createDataSource</span><span class="params">(DataSourceProperty dataSourceProperty)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前创建器是否支持根据此属性创建</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSourceProperty 数据源属性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否支持</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">support</span><span class="params">(DataSourceProperty dataSourceProperty)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataSourceCreator是一个接口，定义了根据参数创建数据源的接口。<br>其他creator实现此接口，本项目暂时实现了Druid和Hikaricp的等连接池的实现。<br>BasicDataSourceCreator 是调用Spring原生的创建方式，只支持最最原始的基础配置。<br>DefaultDataSourceCreator 是一个通用的创建器，其根据环境自动选择连接池，</p>
<h2 id="动态解析数据源"><a href="#动态解析数据源" class="headerlink" title="动态解析数据源"></a>动态解析数据源</h2><h3 id="基础介绍-9"><a href="#基础介绍-9" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>默认有三个职责链来处理动态参数解析器 header-&gt;session-&gt;spel<br>所有以 <code>#</code> 开头的参数都会从参数中获取数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@DS(&quot;#session.tenantName&quot;)</span><span class="comment">//从session获取</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">selectSpelBySession</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> userMapper.selectUsers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DS(&quot;#header.tenantName&quot;)</span><span class="comment">//从header获取</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">selectSpelByHeader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> userMapper.selectUsers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DS(&quot;#tenantName&quot;)</span><span class="comment">//使用spel从参数获取</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">selectSpelByKey</span><span class="params">(String tenantName)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> userMapper.selectUsers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DS(&quot;#user.tenantName&quot;)</span><span class="comment">//使用spel从复杂参数获取</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">selecSpelByTenant</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> userMapper.selectUsers();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何扩展"><a href="#如何扩展" class="headerlink" title="如何扩展?"></a>如何扩展?</h3><ol>
<li>我想从cookie中获取参数解析?</li>
<li>我想从其他环境属性中来计算?</li>
</ol>
<p>参考header解析器,继承DsProcessor,如果matches返回true则匹配成功,调用doDetermineDatasource返回匹配到的数据源,否则跳到写一个解析器.</p>
<h4 id="1-自定义一个处理器。"><a href="#1-自定义一个处理器。" class="headerlink" title="1. 自定义一个处理器。"></a>1. 自定义一个处理器。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DsHeaderProcessor</span> <span class="keyword">extends</span> <span class="title">DsProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEADER_PREFIX = <span class="string">&quot;#header&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> key.startsWith(HEADER_PREFIX);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doDetermineDatasource</span><span class="params">(MethodInvocation invocation, String key)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest request = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">        <span class="keyword">return</span> request.getHeader(key.substring(<span class="number">8</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-重写完后重新注入一个根据自己解析顺序的解析处理器"><a href="#2-重写完后重新注入一个根据自己解析顺序的解析处理器" class="headerlink" title="2. 重写完后重新注入一个根据自己解析顺序的解析处理器."></a>2. 重写完后重新注入一个根据自己解析顺序的解析处理器.</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDynamicDataSourceConfig</span></span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> DsProcessor <span class="title">dsProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DsHeaderProcessor headerProcessor = <span class="keyword">new</span> DsHeaderProcessor();</span><br><span class="line">        DsSessionProcessor sessionProcessor = <span class="keyword">new</span> DsSessionProcessor();</span><br><span class="line">        DsSpelExpressionProcessor spelExpressionProcessor = <span class="keyword">new</span> DsSpelExpressionProcessor();</span><br><span class="line">        headerProcessor.setNextProcessor(sessionProcessor);</span><br><span class="line">        sessionProcessor.setNextProcessor(spelExpressionProcessor);</span><br><span class="line">        <span class="keyword">return</span> headerProcessor;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>如果</p>
<p>在Mapper接口下面的方法使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span></span>&#123;</span><br><span class="line">    <span class="comment">// 前缀可以是p0,a0</span></span><br><span class="line">    <span class="meta">@DS(&quot;#p0.tenantName&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">selecSpelByTenant</span><span class="params">(User user)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于在接口下面的使用, 由于编译器的默认配置没有将接口参数的元数据写入字节码文件中.<br>所以spring el会无法识别参数名称, 只能用默认的参数命名方式</p>
<ol>
<li>第一个参数: p0,a0,(加入-parameter后,可以使用参数具体的名字,例如这里的#user)</li>
<li>第二个参数: p1,a1</li>
<li>第三个参数: P2,a2</li>
</ol>
<p>可以通过修改maven配置和java编译配置将接口参数信息写入字节码文件<br>maven配置:</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;!-- 想启用  &lt;parameters&gt;true&lt;/parameters&gt; 的maven编译最低版本为:3.6.2 --&gt;</span><br><span class="line">    &lt;version&gt;3.6.2&lt;/version&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;source&gt;$&#123;java.version&#125;&lt;/source&gt;</span><br><span class="line">        &lt;target&gt;$&#123;java.version&#125;&lt;/target&gt;</span><br><span class="line">        &lt;parameters&gt;true&lt;/parameters&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>

<p>idea java编译配置: <code>-parameters</code></p>
<blockquote>
<p>java 支持-parameters的最低版本为 1.8</p>
</blockquote>
<h2 id="数据库加密"><a href="#数据库加密" class="headerlink" title="数据库加密"></a>数据库加密</h2><h3 id="基础介绍-10"><a href="#基础介绍-10" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>在一些项目中，有对数据库关键字段加密的需求，大家熟悉的是Druid的加密方式。</p>
<p>在连接池集成中的Druid章节里有对应的加密方式，但是如果我不用Druid也想用加密呢？</p>
<p>所以作者copy了Druid的加密相关源码，嘿嘿。</p>
<p>本项目也支持支持<code>url , username, password</code> 的加密。</p>
<p>使用的RAS加密，相关原理文章<a target="_blank" rel="noopener" href="https://www.cnblogs.com/pcheng/p/9629621.html%E3%80%82">https://www.cnblogs.com/pcheng/p/9629621.html。</a><br>简单来说就是生成两把钥匙，私钥加密，公钥解密。 公钥可以发布出去，解密也是用的公钥。</p>
<h3 id="具体使用"><a href="#具体使用" class="headerlink" title="具体使用"></a>具体使用</h3><h4 id="1-获得加密字符串。"><a href="#1-获得加密字符串。" class="headerlink" title="1. 获得加密字符串。"></a>1. 获得加密字符串。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.toolkit.CryptoUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String password = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">        <span class="comment">//使用默认的publicKey ，建议还是使用下面的自定义</span></span><br><span class="line">        String encodePassword = CryptoUtils.encrypt(password);</span><br><span class="line">        System.out.println(encodePassword);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//自定义publicKey</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String[] arr = CryptoUtils.genKeyPair(<span class="number">512</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;privateKey:  &quot;</span> + arr[<span class="number">0</span>]);</span><br><span class="line">        System.out.println(<span class="string">&quot;publicKey:  &quot;</span> + arr[<span class="number">1</span>]);</span><br><span class="line">        System.out.println(<span class="string">&quot;url:  &quot;</span> + CryptoUtils.encrypt(arr[<span class="number">0</span>], <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/order&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;username:  &quot;</span> + CryptoUtils.encrypt(arr[<span class="number">0</span>], <span class="string">&quot;root&quot;</span>));</span><br><span class="line">        System.out.println(<span class="string">&quot;password:  &quot;</span> + CryptoUtils.encrypt(arr[<span class="number">0</span>], <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img.kancloud.cn/2c/ff/2cffd7b2b2b551c51d0554bc49b9c2e8_3034x306.png" alt="img"></p>
<h4 id="2-配置加密yml。"><a href="#2-配置加密yml。" class="headerlink" title="2. 配置加密yml。"></a>2. 配置加密yml。</h4><p>ENC(xxx)` 中包裹的xxx即为使用加密方法后生成的字符串。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      public-key: #有默认值，强烈建议更换</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          url: ENC(xxxxx)</span><br><span class="line">          username: ENC(xxxxx)</span><br><span class="line">          password: ENC(xxxxx)</span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          public-key: #每个数据源可以独立设置，没有就继承上面的。</span><br></pre></td></tr></table></figure>

<h2 id="启动初始化执行脚本"><a href="#启动初始化执行脚本" class="headerlink" title="启动初始化执行脚本"></a>启动初始化执行脚本</h2><h3 id="启动初始化执行脚本-1"><a href="#启动初始化执行脚本-1" class="headerlink" title="启动初始化执行脚本"></a>启动初始化执行脚本</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: order</span><br><span class="line">      datasource:</span><br><span class="line">        order:</span><br><span class="line">          # 基础配置省略...</span><br><span class="line">          schema: db/order/schema.sql # 配置则生效,自动初始化表结构</span><br><span class="line">          data: db/order/data.sql # 配置则生效,自动初始化数据</span><br><span class="line">          continue-on-error: true # 默认true,初始化失败是否继续</span><br><span class="line">          separator: &quot;;&quot; # sql默认分号分隔符，一般无需更改</span><br><span class="line">        product:</span><br><span class="line">          schema: classpath*:db/product/schema.sql</span><br><span class="line">          data: classpath*:db/product/data.sql</span><br><span class="line">        user:</span><br><span class="line">          schema: classpath*:db/user/schema<span class="comment">/**/*.sql</span></span><br><span class="line"><span class="comment">          data: classpath*:db/user/data/**/</span>*.sql</span><br></pre></td></tr></table></figure>

<h2 id="懒启动数据源"><a href="#懒启动数据源" class="headerlink" title="懒启动数据源"></a>懒启动数据源</h2><h3 id="基础介绍-11"><a href="#基础介绍-11" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>懒启动：连接池创建出来后并不会立即初始化连接池，等需要使用connection的时候再初始化。</p>
<p>暂时只支持Druid和HikariCp和BeeCp连接池。</p>
<p>主要场景可能适合于数据源很多，又不需要启动立即初始化的情况，可以减少系统启动时间。</p>
<p><strong>缺点</strong>在于，如果参数配置有误，则启动的时候不知道，初始化的时候失败，可能一直抛异常。</p>
<h3 id="配置使用"><a href="#配置使用" class="headerlink" title="配置使用"></a>配置使用</h3><figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: master #设置默认的数据源或者数据源组,默认值即为master</span><br><span class="line">      strict: false #设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源.</span><br><span class="line">      lazy: true #默认false非懒启动，系统加载到数据源立即初始化连接池</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3306/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">          lazy: true #表示这个数据源懒启动</span><br><span class="line">        db1:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3307/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        db2:</span><br><span class="line">          url: jdbc:mysql:<span class="comment">//xx.xx.xx.xx:3307/dynamic</span></span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          driver-class-name: com.mysql.jdbc.Driver</span><br></pre></td></tr></table></figure>

<h2 id="无数据源启动"><a href="#无数据源启动" class="headerlink" title="无数据源启动"></a>无数据源启动</h2><h3 id="基础介绍-12"><a href="#基础介绍-12" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>场景：部分系统可能启动的时候完全不需要数据源，全靠启动后动态添加。</p>
<h3 id="配置方式"><a href="#配置方式" class="headerlink" title="配置方式"></a>配置方式</h3><p>即基本不需要配置，可能根据需要配置一些类似Druid和HikariCp全局参数。</p>
<p>如需配置Druid和HikariCp全局参数可参考对应章节文档。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: master #设置默认的数据源或者数据源组,默认值即为master</span><br><span class="line">      strict: false #设置严格模式,默认false不启动. 启动后在未匹配到指定数据源时候会抛出异常,不启动则使用默认数据源.</span><br></pre></td></tr></table></figure>

<p>因为没有匹配的主数据源，启动的时候你会见到类似如下日志。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">dynamic-datasource initial loaded <span class="number">0</span> datasource,Please add your primary datasource or check your configuration</span><br></pre></td></tr></table></figure>

<h2 id="手动切换数据源"><a href="#手动切换数据源" class="headerlink" title="手动切换数据源"></a>手动切换数据源</h2><p>在某些情况您可能需要手动切换数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.toolkit.DynamicDataSourceContextHolder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DynamicDataSourceContextHolder.push(<span class="string">&quot;slave&quot;</span>);<span class="comment">//手动切换</span></span><br><span class="line">    <span class="keyword">return</span>  jdbcTemplate.queryForList(<span class="string">&quot;select * from user&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="手动注入多数据源"><a href="#手动注入多数据源" class="headerlink" title="手动注入多数据源"></a>手动注入多数据源</h2><p>什么时候需要手动注入多数据源？</p>
<p>绝大部分是因为您的系统需要和其他数据源共同存在使用。如Quartz和ShardingJdbc等都需要使用独立的数据源。</p>
<hr>
<p>dynamic-datasource 3.4.0及以上版本和老版本注入方式有一定差别，根据自己版本注入。</p>
<p>注意一定要让多数据源使用 <strong>@Primary</strong> ,让其成为主数据源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//3.4.0版本以下</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">(DynamicDataSourceProvider dynamicDataSourceProvider)</span> </span>&#123; </span><br><span class="line">    DynamicRoutingDataSource dataSource = <span class="keyword">new</span> DynamicRoutingDataSource();</span><br><span class="line">    dataSource.setPrimary(properties.getPrimary());</span><br><span class="line">    dataSource.setStrict(properties.getStrict());</span><br><span class="line">    dataSource.setStrategy(properties.getStrategy());</span><br><span class="line">    dataSource.setProvider(dynamicDataSourceProvider);</span><br><span class="line">    dataSource.setP6spy(properties.getP6spy());</span><br><span class="line">    dataSource.setSeata(properties.getSeata());</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.4.0版本及以上</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DynamicRoutingDataSource dataSource = <span class="keyword">new</span> DynamicRoutingDataSource();</span><br><span class="line">    dataSource.setPrimary(properties.getPrimary());</span><br><span class="line">    dataSource.setStrict(properties.getStrict());</span><br><span class="line">    dataSource.setStrategy(properties.getStrategy());</span><br><span class="line">    dataSource.setP6spy(properties.getP6spy());</span><br><span class="line">    dataSource.setSeata(properties.getSeata());</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要变更是因为3.4.0支持了多个provider同时生效，采取了内部注入。 源码改动参考<a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/6e8d2954499f83269302d23b58f8832c31e07ef7">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/6e8d2954499f83269302d23b58f8832c31e07ef7</a></p>
<h1 id="自定义"><a href="#自定义" class="headerlink" title="自定义"></a>自定义</h1><p><strong>自定义注解</strong>：不满足于默认DS注解，希望自定义注解。</p>
<hr>
<p><strong>自定义数据源来源</strong>：默认的数据源来源是基于yml或者properties配置来的，组件支持同时从多个地方来加载初始化数据源。 常用于多租户系统，从一个租户信息库多加载不同租户的数据源。</p>
<hr>
<p><strong>自定义负载均衡策略</strong>：常用的有轮询，随机。支持扩展。</p>
<hr>
<p><strong>自定义切面</strong>：支持<strong>不使用注解</strong>，通过配置来切换数据源。<br>如某个包下所有service方法以<code>select*</code>开头的都走slave库，以<code>add*</code>开头的都走master库。</p>
<h2 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h2><h3 id="基础介绍-13"><a href="#基础介绍-13" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>如果你只有几个确定的库，可以尝试自定义注解替换掉<code>@DS</code>。</p>
<p>建议从3.2.1版本开始使用自定义注解，另外组件自带了<code>@Master</code>和<code>@Slave</code>注解。</p>
<h3 id="使用方法-3"><a href="#使用方法-3" class="headerlink" title="使用方法"></a>使用方法</h3><p>下面我们自定义一个产品库的注解，方便我们后面程序的使用。</p>
<h4 id="1-需要自己定义一个注解并继承自DS。"><a href="#1-需要自己定义一个注解并继承自DS。" class="headerlink" title="1. 需要自己定义一个注解并继承自DS。"></a>1. 需要自己定义一个注解并继承自DS。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.baomidou.dynamic.datasource.annotation.DS;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@DS(&quot;product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Product &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-注解在需要切换数据源的方法上或类上。"><a href="#2-注解在需要切换数据源的方法上或类上。" class="headerlink" title="2. 注解在需要切换数据源的方法上或类上。"></a>2. 注解在需要切换数据源的方法上或类上。</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Product</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Product</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List <span class="title">selectAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span>  jdbcTemplate.queryForList(<span class="string">&quot;select * from products&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="自定义数据源来源"><a href="#自定义数据源来源" class="headerlink" title="自定义数据源来源"></a>自定义数据源来源</h2><h3 id="自定义数据源来源-1"><a href="#自定义数据源来源-1" class="headerlink" title="自定义数据源来源"></a>自定义数据源来源</h3><h3 id="基础介绍-14"><a href="#基础介绍-14" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>数据源来源的默认实现是<code>YmlDynamicDataSourceProvider</code>，其从yaml或properties中读取信息并解析出所有数据源信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DynamicDataSourceProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载所有数据源</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 所有数据源，key为数据源名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Map&lt;String, DataSource&gt; <span class="title">loadDataSources</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义示例"><a href="#自定义示例" class="headerlink" title="自定义示例"></a>自定义示例</h3><p>可以参考 <code>AbstractJdbcDataSourceProvider</code> （仅供参考）来实现从JDBC数据库中获取数据库连接信息。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DynamicDataSourceProvider <span class="title">jdbcDynamicDataSourceProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AbstractJdbcDataSourceProvider(<span class="string">&quot;org.h2.Driver&quot;</span>, <span class="string">&quot;jdbc:h2:mem:test&quot;</span>, <span class="string">&quot;sa&quot;</span>, <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Map&lt;String, DataSourceProperty&gt; <span class="title">executeStmt</span><span class="params">(Statement statement)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">            ResultSet rs = statement.executeQuery(<span class="string">&quot;select * from DB&quot;</span>);</span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                String name = rs.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                String username = rs.getString(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">                String password = rs.getString(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">                String url = rs.getString(<span class="string">&quot;url&quot;</span>);</span><br><span class="line">                String driver = rs.getString(<span class="string">&quot;driver&quot;</span>);</span><br><span class="line">                DataSourceProperty property = <span class="keyword">new</span> DataSourceProperty();</span><br><span class="line">                property.setUsername(username);</span><br><span class="line">                property.setPassword(password);</span><br><span class="line">                property.setUrl(url);</span><br><span class="line">                property.setDriverClassName(driver);</span><br><span class="line">                map.put(name, property);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PS: 从3.4.0开始，可以注入多个DynamicDataSourceProvider的Bean以实现同时从多个不同来源加载数据源，注意同名会被覆盖。</p>
<h2 id="自定义负载均衡策略"><a href="#自定义负载均衡策略" class="headerlink" title="自定义负载均衡策略"></a>自定义负载均衡策略</h2><h3 id="自定义负载均衡策略-1"><a href="#自定义负载均衡策略-1" class="headerlink" title="自定义负载均衡策略"></a>自定义负载均衡策略</h3><h3 id="基础介绍-15"><a href="#基础介绍-15" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>如下图<code>slave</code>组下有三个数据源，当用户使用<code>slave</code>切换数据源时会使用负载均衡算法。</p>
<p>系统自带了两个负载均衡算法</p>
<ul>
<li><code>LoadBalanceDynamicDataSourceStrategy</code> 轮询,是默认的。</li>
<li><code>RandomDynamicDataSourceStrategy</code> 随机的。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      datasource:</span><br><span class="line">        master:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">          schema: db/schema.sql</span><br><span class="line">        slave_1:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">        slave_2:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">        slave_3:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">      strategy: com.baomidou.dynamic.datasource.strategy.LoadBalanceDynamicDataSourceStrategy</span><br></pre></td></tr></table></figure>

<h3 id="如何自定义"><a href="#如何自定义" class="headerlink" title="如何自定义"></a>如何自定义</h3><p>如果默认的两个都不能满足要求，可以参考源码自定义。 暂时只能全局更改。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomDynamicDataSourceStrategy</span> <span class="keyword">implements</span> <span class="title">DynamicDataSourceStrategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RandomDynamicDataSourceStrategy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">determineDataSource</span><span class="params">(List&lt;DataSource&gt; dataSources)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (DataSource)dataSources.get(ThreadLocalRandom.current().nextInt(dataSources.size()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="无注解方案"><a href="#无注解方案" class="headerlink" title="无注解方案"></a>无注解方案</h1><h2 id="无注解必读"><a href="#无注解必读" class="headerlink" title="无注解必读"></a>无注解必读</h2><p>不管是出于注解侵入性还是代码整洁等理由，我们都有需求不想使用注解的需求。</p>
<p>但是需要理解本多数据源实现的核心。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRoutingDataSource</span> </span>&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">determineDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里是核心，是从ThreadLocal中获取当前数据源。</span></span><br><span class="line">    String dsKey = DynamicDataSourceContextHolder.peek();</span><br><span class="line">    <span class="keyword">return</span> getDataSource(dsKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们就可以根据需求，选择合适的时机调用DynamicDataSourceContextHolder.push(“对应数据源”)。</p>
<p>默认的<code>@DS</code>注解来切换数据源是根据spring AOP的特性，在方法开启前设置数据源KEY，方法执行完成后移除对应数据源KEY。</p>
<h2 id="filter切换数据源"><a href="#filter切换数据源" class="headerlink" title="filter切换数据源"></a>filter切换数据源</h2><p>目标：拦截以filter/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。</p>
<p>实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@WebFilter(filterName = &quot;dsFilter&quot;, urlPatterns = &#123;&quot;/filter/*&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDatasourceFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;loading filter &#123;&#125;&quot;</span>, filterConfig.getFilterName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        HttpServletRequest request = (HttpServletRequest) servletRequest;</span><br><span class="line">        HttpServletResponse response = (HttpServletResponse) servletResponse;</span><br><span class="line"></span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;经过多数据源filter,当前路径是&#123;&#125;&quot;</span>, requestURI);</span><br><span class="line"><span class="comment">//        String headerDs = request.getHeader(&quot;ds&quot;);</span></span><br><span class="line"><span class="comment">//        Object sessionDs = request.getSession().getAttribute(&quot;ds&quot;);</span></span><br><span class="line">        String s = requestURI.replaceFirst(<span class="string">&quot;/filter/&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String dsKey = <span class="string">&quot;master&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;a&quot;</span>)) &#123;</span><br><span class="line">            dsKey = <span class="string">&quot;db1&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;b&quot;</span>)) &#123;</span><br><span class="line">            dsKey = <span class="string">&quot;db2&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//执行</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.push(dsKey);</span><br><span class="line">            filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@ServletComponentScan</span> <span class="comment">//filter必须使用这个</span></span><br><span class="line"><span class="meta">@MapperScan(&quot;com.baomidou.samples.ds.mapper&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AllDataSourceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(AllDataSourceApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应源码： <a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/all-datasource-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/all-datasource-sample</a><br>扩展：从request中还能获取到很多东西，如header和session，是否同理可以根据自己业务需求根据header值和session里对应的用户来动态设置和切换数据源？</p>
<h2 id="intercepror切换数据源"><a href="#intercepror切换数据源" class="headerlink" title="intercepror切换数据源"></a>intercepror切换数据源</h2><p>目标：拦截以filter/**开头的所有请求，如果后面的方法以a开头就切换到db1，以b开头就切换到db2，其余使用默认数据源。</p>
<p>实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDatasourceInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在请求处理之前进行调用（Controller方法调用之前）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> </span>&#123;</span><br><span class="line">        String requestURI = request.getRequestURI();</span><br><span class="line">        log.info(<span class="string">&quot;经过多数据源Interceptor,当前路径是&#123;&#125;&quot;</span>, requestURI);</span><br><span class="line"><span class="comment">//        String headerDs = request.getHeader(&quot;ds&quot;);</span></span><br><span class="line"><span class="comment">//        Object sessionDs = request.getSession().getAttribute(&quot;ds&quot;);</span></span><br><span class="line">        String s = requestURI.replaceFirst(<span class="string">&quot;/interceptor/&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String dsKey = <span class="string">&quot;master&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;a&quot;</span>)) &#123;</span><br><span class="line">            dsKey = <span class="string">&quot;db1&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s.startsWith(<span class="string">&quot;b&quot;</span>)) &#123;</span><br><span class="line">            dsKey = <span class="string">&quot;db2&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        DynamicDataSourceContextHolder.push(dsKey);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求处理之后进行调用，但是在视图被渲染之前（Controller方法调用之后）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在整个请求结束之后被调用，也就是在DispatcherServlet 渲染了对应的视图之后执行（主要是用于进行资源清理工作）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> </span>&#123;</span><br><span class="line">        DynamicDataSourceContextHolder.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWebAutoConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> DynamicDatasourceInterceptor()).addPathPatterns(<span class="string">&quot;/interceptor/**&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应源码： <a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/all-datasource-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/all-datasource-sample</a></p>
<p>扩展：从request中还能获取到很多东西，如header和session，是否同理可以根据自己业务需求根据header值和session里对应的用户来动态设置和切换数据源？</p>
<h2 id="自定义切面"><a href="#自定义切面" class="headerlink" title="自定义切面"></a>自定义切面</h2><p>从3.4.0开始支持自定义切面。</p>
<ol>
<li>使用这个方式，原注解方式并不会失效。</li>
<li>注意：不要在同一个切面同时使用注解又使用自定义切面。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DynamicDatasourceNamedInterceptor <span class="title">dsAdvice</span><span class="params">(DsProcessor dsProcessor)</span> </span>&#123;</span><br><span class="line">        DynamicDatasourceNamedInterceptor interceptor = <span class="keyword">new</span> DynamicDatasourceNamedInterceptor(dsProcessor);</span><br><span class="line">        Map&lt;String, String&gt; patternMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        patternMap.put(<span class="string">&quot;select*&quot;</span>, <span class="string">&quot;slave&quot;</span>);</span><br><span class="line">        patternMap.put(<span class="string">&quot;add*&quot;</span>, <span class="string">&quot;master&quot;</span>);</span><br><span class="line">        patternMap.put(<span class="string">&quot;update*&quot;</span>, <span class="string">&quot;master&quot;</span>);</span><br><span class="line">        patternMap.put(<span class="string">&quot;delete*&quot;</span>, <span class="string">&quot;master&quot;</span>);</span><br><span class="line">        interceptor.addPatternMap(patternMap);</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Advisor <span class="title">dsAdviceAdvisor</span><span class="params">(DynamicDatasourceNamedInterceptor dsAdvice)</span> </span>&#123;</span><br><span class="line">        AspectJExpressionPointcut pointcut = <span class="keyword">new</span> AspectJExpressionPointcut();</span><br><span class="line">        pointcut.setExpression(<span class="string">&quot;execution (* com.baomidou.samples.pattern..service.*.*(..))&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultPointcutAdvisor(pointcut, dsAdvice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上实现com.baomidou.samples.pattern包service下所有类的add和update,delete开头的方法使用master数据源，select使用slave数据源。</p>
<p>更复杂的切点表达式语法需自行学习。</p>
<p>示例项目 <a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/name-pattern-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/name-pattern-sample</a></p>
<h2 id="mybatis下读写分离"><a href="#mybatis下读写分离" class="headerlink" title="mybatis下读写分离"></a>mybatis下读写分离</h2><h3 id="自动读写分离"><a href="#自动读写分离" class="headerlink" title="自动读写分离"></a>自动读写分离</h3><p>场景：</p>
<ol>
<li>在纯的读写分离环境，写操作全部是master，读操作全部是slave。</li>
<li>不想通过注解配置完成以上功能。</li>
</ol>
<p>答：在mybatis环境下可以基于mybatis插件结合本数据源完成以上功能。</p>
<p>手动注入插件。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> MasterSlaveAutoRoutingPlugin <span class="title">masterSlaveAutoRoutingPlugin</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> MasterSlaveAutoRoutingPlugin();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认主库名称master,从库名称slave。</p>
<p>暂不支持更多，源码简单可参考重写。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Intercepts(&#123;@Signature(type = Executor.class, method = &quot;query&quot;, args = &#123;MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class&#125;),</span></span><br><span class="line"><span class="meta">        @Signature(type = Executor.class, method = &quot;update&quot;, args = &#123;MappedStatement.class, Object.class&#125;)&#125;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterSlaveAutoRoutingPlugin</span> <span class="keyword">implements</span> <span class="title">Interceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MASTER = <span class="string">&quot;master&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SLAVE = <span class="string">&quot;slave&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object[] args = invocation.getArgs();</span><br><span class="line">        MappedStatement ms = (MappedStatement) args[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.push(SqlCommandType.SELECT == ms.getSqlCommandType() ? SLAVE : MASTER);</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">plugin</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target <span class="keyword">instanceof</span> Executor ? Plugin.wrap(target, <span class="keyword">this</span>) : target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties properties)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="事务专栏"><a href="#事务专栏" class="headerlink" title="事务专栏"></a>事务专栏</h1><p>使用多数据源的你一定会遇到事务问题。</p>
<hr>
<ol>
<li>为什么使用了事务就切换不了数据源了啊？</li>
<li>有没有什么解决方案啊？</li>
<li>有没有使用案例和注意事项啊。</li>
</ol>
<p>以上问题都能在本章节得到解答。</p>
<hr>
<p>方案一：本组件集成了alibaba分布式事务组件seata。</p>
<p>方案二：本组件提供了无需外部组件的本地多数据源事物。</p>
<p>各有自己的优劣，总有一款适合你。</p>
<h2 id="事务概念"><a href="#事务概念" class="headerlink" title="事务概念"></a>事务概念</h2><ul>
<li><ul>
<li></li>
</ul>
</li>
</ul>
<h3 id="什么是事务？"><a href="#什么是事务？" class="headerlink" title="什么是事务？"></a>什么是事务？</h3><p><strong>事务</strong>：是数据库操作的最小工作单元，是作为单个逻辑工作单元执行的一系列操作；这些操作作为一个整体一起向系统提交，要么都执行、要么都不执行；事务是一组不可再分割的操作集合（工作逻辑单元）。</p>
<p><strong>事务的四大特性：</strong></p>
<blockquote>
<ol>
<li>原子性<br>事务是数据库的逻辑工作单位，事务中包含的各操作要么都做，要么都不做 。</li>
<li>一致性<br>事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。因此当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态。如果数据库系统 运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是 不一致的状态。</li>
<li>隔离性<br>一个事务的执行不能其它事务干扰。即一个事务内部的操作及使用的数据对其它并发事务是隔离的，并发执行的各个事务之间不能互相干扰。</li>
<li>持续性<br>也称永久性，指一个事务一旦提交，它对数据库中的数据的改变就应该是永久性的。接下来的其它操作或故障不应该对其执行结果有任何影响。</li>
</ol>
</blockquote>
<h3 id="原生JDBC处理事务。"><a href="#原生JDBC处理事务。" class="headerlink" title="原生JDBC处理事务。"></a>原生JDBC处理事务。</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    connection.setAutoCommit( <span class="keyword">false</span>);  </span><br><span class="line">      <span class="comment">//这里用connection对数据库做了一系列操作，CRUD</span></span><br><span class="line">    connection.commit();<span class="comment">//没有异常就提交</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">    connection.rollback();  <span class="comment">//异常回滚</span></span><br><span class="line">&#125;<span class="keyword">finally</span>&#123;  </span><br><span class="line">    connection.setAutoCommit( <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上是事务的核心，所有操作要一起成功，只要出错就回滚。</p>
<h3 id="Spring处理事务。"><a href="#Spring处理事务。" class="headerlink" title="Spring处理事务。"></a>Spring处理事务。</h3><p>spring开启事务很简单，在需要事务的方法和类上添加 <code>@Transactional</code>注解。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      Aservice.dosometing();</span><br><span class="line">      Bservice.dosometing();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了 <code>@Transactional</code>，<strong>spring会保证整个事务下都复用同一个connection。</strong><br>在默认配置下，只要事务中发生RuntimeException，就会回滚。</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><h3 id="基础知识-1"><a href="#基础知识-1" class="headerlink" title="基础知识"></a>基础知识</h3><h3 id="问：使用了事务如-Transational-无法切换数据源？"><a href="#问：使用了事务如-Transational-无法切换数据源？" class="headerlink" title="问：使用了事务如@Transational 无法切换数据源？"></a>问：使用了事务如@Transational 无法切换数据源？</h3><p>答： 是的，本组件是基于springAop的方案来进行多数据源的管理和切换的，要想保证多个库的整体事务则需要分布式事务。</p>
<h3 id="问：为什么使用了事务如-Transational就无法切换数据源？"><a href="#问：为什么使用了事务如-Transational就无法切换数据源？" class="headerlink" title="问：为什么使用了事务如@Transational就无法切换数据源？"></a>问：为什么使用了事务如@Transational就无法切换数据源？</h3><p>答：开启了事务后，spring事务管理器会保证在事务下整个线程后续拿到的都是同一个connection。</p>
<h3 id="问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？"><a href="#问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？" class="headerlink" title="问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？"></a>问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？</h3><p>答：完全可以的。 只要事务下不切换数据源就OK。</p>
<h3 id="问：我的业务必须要保证事务，还有什么解决办法？"><a href="#问：我的业务必须要保证事务，还有什么解决办法？" class="headerlink" title="问：我的业务必须要保证事务，还有什么解决办法？"></a>问：我的业务必须要保证事务，还有什么解决办法？</h3><p>方案一：seata就是解决此问题，本组件已完成和seata的自动集成。</p>
<p>方案二：本组件从3.3.0开始支持本地多数据源事务，无需第三方。</p>
<p>查看左侧边栏对应的详细文档。</p>
<h3 id="还有没有其他方案？"><a href="#还有没有其他方案？" class="headerlink" title="还有没有其他方案？"></a>还有没有其他方案？</h3><p>答： 如果数据源只有几个，又不怕复杂，可以放弃本组件。</p>
<p>尝试手动构建数据源结合JTA方案 如 <a target="_blank" rel="noopener" href="https://www.cnblogs.com/cicada-smile/p/13289306.html%E3%80%82">https://www.cnblogs.com/cicada-smile/p/13289306.html。</a></p>
<p>本文不做详解，如果连接失效或者还是不清楚可以自行各渠道搜索 <strong><em>多数据源JTA</em></strong>。</p>
<p>另外建议不理解或不清楚分布式事务的同学，自行先通过搜索引擎 <strong><em>分布式事务</em></strong> 和 <strong><em>CAP定理</em></strong> 学习相关概念。</p>
<p>程序员小灰的分布式事务 <a target="_blank" rel="noopener" href="https://blog.csdn.net/bjweimengshu/article/details/79607522">https://blog.csdn.net/bjweimengshu/article/details/79607522</a></p>
<p>程序员小灰的CAP定理 <a target="_blank" rel="noopener" href="https://blog.csdn.net/bjweimengshu/article/details/79338859">https://blog.csdn.net/bjweimengshu/article/details/79338859</a></p>
<h2 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h2><h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>多数据源事务方案一直是一个难题，通常的解决方案有以下二种。</p>
<ol>
<li>利用atomiks手动构建多数据源事务，适合数据源较少，配置的参数也不太多,性能要求不高的项目。难点就是手动配置量大，需要耗费一定时间。</li>
<li>用seata类似的分布式事务解决方案,难点就是需要搭建维护如seata-server的统一管理中心。</li>
</ol>
<p>每一种方案都有其适用场景，本项目作者常常收到的问题就是。</p>
<ol>
<li>为什么我加了事务注解，切换数据源失败？</li>
<li>我了解涉及了分布式事务了，但我不想用seata。我场景简单，有没有不依赖第三方的方案？</li>
</ol>
<h3 id="基础介绍-16"><a href="#基础介绍-16" class="headerlink" title="基础介绍"></a>基础介绍</h3><p>自从3.3.0开始，由seata的核心贡献者<a target="_blank" rel="noopener" href="https://github.com/a364176773">https://github.com/a364176773</a> 贡献了基于connection代理的方案。<br>建议从3.4.0版本开始使用，其修复了一个功能，老版本不加<code>@DS</code>只加<code>@DSTransactional</code>会报错。</p>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><ol>
<li>不支持spring原生事务，不支持spring事务，不支持spring事务，可分别使用，<strong>千万不能混用</strong>。</li>
<li>再次强调不支持spring事务注解，可理解成独立写了一套事务方案。</li>
<li>只适合简单本地多数据源场景， 如果涉及异步和微服务等完整事务场景，请使用seata方案。</li>
<li>暂时不支持更多配置，如只读，如spring的传播特性。 后续会根据反馈考虑支持。</li>
</ol>
<h3 id="使用方法-4"><a href="#使用方法-4" class="headerlink" title="使用方法"></a>使用方法</h3><p>在最外层的方法添加 <code>@DSTransactional</code>，底下调用的各个类该切数据源就正常使用<code>DS</code>切换数据源即可。 就是这么简单。~</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如AService调用BService和CService的方法，A,B,C分别对应不同数据源。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;a&quot;)</span><span class="comment">//如果a是默认数据源则不需要DS注解。</span></span><br><span class="line">    <span class="meta">@DSTransactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        BService.dosomething();</span><br><span class="line">        CService.dosomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;b&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//dosomething</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;c&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//dosomething</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只要<code>@DSTransactional</code>注解下任一环节发生异常，则全局多数据源事务回滚。<br>如果BC上也有<code>@DSTransactional</code>会有影响吗？答：没有影响的。</p>
<h3 id="示例项目-4"><a href="#示例项目-4" class="headerlink" title="示例项目"></a>示例项目</h3><p>示例项目A,B,C分别对应OrderService,ProductService，AccountService。分别是独立的数据库。</p>
<p>用户下单分别调用产品库扣库存，账户库扣余额。<br>如果库存不足，或用户余额不足都抛出RuntimeException,触发整体回滚。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OrderMapper orderMapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccountService accountService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductService productService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//@DS(&quot;order&quot;) 这里不需要，因为order是默认库，如果开启事务的不是默认库则必须加</span></span><br><span class="line">    <span class="meta">@DSTransactional</span> <span class="comment">//注意这里开启事务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">placeOrder</span><span class="params">(PlaceOrderRequest request)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=============ORDER START=================&quot;</span>);</span><br><span class="line">        Long userId = request.getUserId();</span><br><span class="line">        Long productId = request.getProductId();</span><br><span class="line">        Integer amount = request.getAmount();</span><br><span class="line">        log.info(<span class="string">&quot;收到下单请求,用户:&#123;&#125;, 商品:&#123;&#125;,数量:&#123;&#125;&quot;</span>, userId, productId, amount);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, TransactionContext.getXID());</span><br><span class="line"></span><br><span class="line">        Order order = Order.builder()</span><br><span class="line">                .userId(userId)</span><br><span class="line">                .productId(productId)</span><br><span class="line">                .status(OrderStatus.INIT)</span><br><span class="line">                .amount(amount)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        orderMapper.insert(order);</span><br><span class="line">        log.info(<span class="string">&quot;订单一阶段生成，等待扣库存付款中&quot;</span>);</span><br><span class="line">        <span class="comment">// 扣减库存并计算总价</span></span><br><span class="line">        Double totalPrice = productService.reduceStock(productId, amount);</span><br><span class="line">        <span class="comment">// 扣减余额</span></span><br><span class="line">        accountService.reduceBalance(userId, totalPrice);</span><br><span class="line"></span><br><span class="line">        order.setStatus(OrderStatus.SUCCESS);</span><br><span class="line">        order.setTotalPrice(totalPrice);</span><br><span class="line">        orderMapper.updateById(order);</span><br><span class="line">        log.info(<span class="string">&quot;订单已成功下单&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;=============ORDER END=================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProductMapper productMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;product&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Double <span class="title">reduceStock</span><span class="params">(Long productId, Integer amount)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=============PRODUCT START=================&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, TransactionContext.getXID());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 检查库存</span></span><br><span class="line">        Product product = productMapper.selectById(productId);</span><br><span class="line">        Assert.notNull(product, <span class="string">&quot;商品不存在&quot;</span>);</span><br><span class="line">        Integer stock = product.getStock();</span><br><span class="line">        log.info(<span class="string">&quot;商品编号为 &#123;&#125; 的库存为&#123;&#125;,订单商品数量为&#123;&#125;&quot;</span>, productId, stock, amount);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (stock &lt; amount) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;商品编号为&#123;&#125; 库存不足，当前库存:&#123;&#125;&quot;</span>, productId, stock);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;开始扣减商品编号为 &#123;&#125; 库存,单价商品价格为&#123;&#125;&quot;</span>, productId, product.getPrice());</span><br><span class="line">        <span class="comment">// 扣减库存</span></span><br><span class="line">        <span class="keyword">int</span> currentStock = stock - amount;</span><br><span class="line">        product.setStock(currentStock);</span><br><span class="line">        productMapper.updateById(product);</span><br><span class="line">        <span class="keyword">double</span> totalPrice = product.getPrice() * amount;</span><br><span class="line">        log.info(<span class="string">&quot;扣减商品编号为 &#123;&#125; 库存成功,扣减后库存为&#123;&#125;, &#123;&#125; 件商品总价为 &#123;&#125; &quot;</span>, productId, currentStock, amount, totalPrice);</span><br><span class="line">        log.info(<span class="string">&quot;=============PRODUCT END=================&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> totalPrice;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AccountMapper accountMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;account&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceBalance</span><span class="params">(Long userId, Double price)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;=============ACCOUNT START=================&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, TransactionContext.getXID());</span><br><span class="line"></span><br><span class="line">        Account account = accountMapper.selectById(userId);</span><br><span class="line">        Assert.notNull(account, <span class="string">&quot;用户不存在&quot;</span>);</span><br><span class="line">        Double balance = account.getBalance();</span><br><span class="line">        log.info(<span class="string">&quot;下单用户&#123;&#125;余额为 &#123;&#125;,商品总价为&#123;&#125;&quot;</span>, userId, balance, price);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (balance &lt; price) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;用户 &#123;&#125; 余额不足，当前余额:&#123;&#125;&quot;</span>, userId, balance);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;开始扣减用户 &#123;&#125; 余额&quot;</span>, userId);</span><br><span class="line">        <span class="keyword">double</span> currentBalance = account.getBalance() - price;</span><br><span class="line">        account.setBalance(currentBalance);</span><br><span class="line">        accountMapper.updateById(account);</span><br><span class="line">        log.info(<span class="string">&quot;扣减用户 &#123;&#125; 余额成功,扣减后用户账户余额为&#123;&#125;&quot;</span>, userId, currentBalance);</span><br><span class="line">        log.info(<span class="string">&quot;=============ACCOUNT END=================&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>完整示例项目 <a target="_blank" rel="noopener" href="https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-local-sample">https://github.com/dynamic-datasource/dynamic-datasource-samples/tree/master/tx-local-sample</a> 数据库都已准备好，可以直接运行测试。<a target="_blank" rel="noopener" href="http://localhost:8080/doc.html">http://localhost:8080/doc.html</a></p>
<p><img src="https://img.kancloud.cn/51/04/5104f1668faa10a4ae07146601ac5f15_638x820.png" alt="img"></p>
<h3 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h3><p>完整支持代码：<a target="_blank" rel="noopener" href="https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/f0cbad193528296eeb64faa76c79743afbdd811d">https://github.com/baomidou/dynamic-datasource-spring-boot-starter/commit/f0cbad193528296eeb64faa76c79743afbdd811d</a></p>
<p>核心原理就是代理connection，并根据不同数据库获取到一个connection放入ConnectionFactory。 如果成功了整体提交，失败了整体回滚。</p>
<h2 id="seata事务"><a href="#seata事务" class="headerlink" title="seata事务"></a>seata事务</h2><h3 id="基础介绍-17"><a href="#基础介绍-17" class="headerlink" title="基础介绍"></a>基础介绍</h3><ul>
<li>seata Github地址 <a target="_blank" rel="noopener" href="https://github.com/seata/seata">https://github.com/seata/seata</a></li>
<li>seata 文档 <a target="_blank" rel="noopener" href="https://seata.io/zh-cn/docs/overview/what-is-seata.html">https://seata.io/zh-cn/docs/overview/what-is-seata.html</a></li>
<li>seata 示例 <a target="_blank" rel="noopener" href="https://github.com/seata/seata-samples">https://github.com/seata/seata-samples</a></li>
<li>seata 最新版本<br><a target="_blank" rel="noopener" href="http://mvnrepository.com/artifact/io.seata/seata-all"><br><img src="https://img.shields.io/maven-central/v/io.seata/seata-all.svg" alt="img"></a> 。</li>
</ul>
<blockquote>
<p>PS：一般需要分布式事务的场景大多数都是微服务化，个人并不建议在单体项目引入多数据源+分布式事务，有能力尽早拆开，可为过度方案。</p>
</blockquote>
<h3 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h3><p><code>dynamic-datasource-sring-boot-starter</code> 组件内部开启seata后会自动使用DataSourceProxy来包装DataSource,所以需要以下方式来保持兼容。</p>
<p>1.如果你引入的是seata-all,请不要使用@EnableAutoDataSourceProxy注解。</p>
<p>2.如果你引入的是seata-spring-boot-starter 请关闭自动代理。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">seata:</span><br><span class="line">  enable-auto-data-source-proxy: <span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<h3 id="示例项目-5"><a href="#示例项目-5" class="headerlink" title="示例项目"></a>示例项目</h3><p>此工程为 多数据源+druid+seata+mybatisPlus的版本。</p>
<p>模拟用户下单，扣商品库存，扣用户余额，初步可分为订单服务+商品服务+用户服务。</p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>为了快速演示相关环境都采用docker部署，生产上线请参考seata官方文档使用。</p>
<ol>
<li>准备seata-server。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">docker run --name seata-server -p <span class="number">8091</span>:<span class="number">8091</span> -d seataio/seata-server</span><br></pre></td></tr></table></figure>

<ol>
<li>准备mysql数据库，账户root密码123456。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">docker run --name mysql -p <span class="number">3306</span>:<span class="number">3306</span> -e MYSQL_ROOT_PASSWORD=<span class="number">123456</span> -d mysql:<span class="number">5.7</span></span><br></pre></td></tr></table></figure>

<ol>
<li>创建相关数据库。</li>
</ol>
<p>创建 <code>seata-order``seata-product``seata-account</code> 模拟连接不同的数据库。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE IF NOT EXIST seata-order;</span><br><span class="line">CREATE DATABASE IF NOT EXIST seata-product;</span><br><span class="line">CREATE DATABASE IF NOT EXIST seata-account;</span><br></pre></td></tr></table></figure>

<ol>
<li>准备相关数据库脚本。</li>
</ol>
<p>每个数据库下脚本相关的表，seata需要undo_log来监测和回滚。</p>
<p>相关的脚本不用自行准备，本工程已在resources/db下面准备好，另外配合多数据源的自动执行脚本功能，应用启动后会自动执行。</p>
<h3 id="工程准备"><a href="#工程准备" class="headerlink" title="工程准备"></a>工程准备</h3><ol>
<li>引入相关依赖，seata+druid+mybatisPlus+dynamic-datasource+mysql+lombok。</li>
</ol>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;io.seata&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.4.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;dynamic-datasource-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;3.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"># 省略，查看示例项目</span><br></pre></td></tr></table></figure>

<ol>
<li>编写相关yaml配置。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: dynamic</span><br><span class="line">  datasource:</span><br><span class="line">    dynamic:</span><br><span class="line">      primary: order</span><br><span class="line">      strict: <span class="keyword">true</span></span><br><span class="line">      seata: true    #开启seata代理，开启后默认每个数据源都代理，如果某个不需要代理可单独关闭</span><br><span class="line">      seata-mode: AT #支持XA及AT模式,默认AT</span><br><span class="line">      datasource:</span><br><span class="line">        order:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/seata_order?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          schema: classpath:db/schema-order.sql</span><br><span class="line">        account:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/seata_account?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          schema: classpath:db/schema-account.sql</span><br><span class="line">        product:</span><br><span class="line">          username: root</span><br><span class="line">          password: <span class="number">123456</span></span><br><span class="line">          url: jdbc:mysql:<span class="comment">//39.108.158.138:3306/seata_product?useUnicode=true&amp;characterEncoding=utf8&amp;allowMultiQueries=true&amp;useSSL=false</span></span><br><span class="line">          driver-class-name: com.mysql.cj.jdbc.Driver</span><br><span class="line">          schema: classpath:db/schema-product.sql</span><br><span class="line">        test:</span><br><span class="line">          username: sa</span><br><span class="line">          password: <span class="string">&quot;&quot;</span></span><br><span class="line">          url: jdbc:h2:mem:test</span><br><span class="line">          driver-class-name: org.h2.Driver</span><br><span class="line">          seata: false #这个数据源不需要seata</span><br><span class="line">seata:</span><br><span class="line">  enabled: <span class="keyword">true</span></span><br><span class="line">  application-id: applicationName</span><br><span class="line">  tx-service-group: my_test_tx_group</span><br><span class="line">  enable-auto-data-source-proxy: false   #一定要是false</span><br><span class="line">  service:</span><br><span class="line">    vgroup-mapping:</span><br><span class="line">      my_test_tx_group: default  #key与上面的tx-service-group的值对应</span><br><span class="line">    grouplist:</span><br><span class="line">      default: 39.108.158.138:8091 #seata-server地址仅file注册中心需要</span><br><span class="line">  config:</span><br><span class="line">    type: file</span><br><span class="line">  registry:</span><br><span class="line">    type: file</span><br></pre></td></tr></table></figure>

<h3 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h3><p>参考工程下面的代码完成controller,service,maaper,entity,dto等。</p>
<p>订单服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> OrderDao orderDao;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> AccountService accountService;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ProductService productService;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@DS(&quot;order&quot;)</span><span class="comment">//每一层都需要使用多数据源注解切换所选择的数据库</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Transactional</span></span><br><span class="line">  <span class="meta">@GlobalTransactional</span> <span class="comment">//重点 第一个开启事务的需要添加seata全局事务注解</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">placeOrder</span><span class="params">(PlaceOrderRequest request)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;=============ORDER START=================&quot;</span>);</span><br><span class="line">    Long userId = request.getUserId();</span><br><span class="line">    Long productId = request.getProductId();</span><br><span class="line">    Integer amount = request.getAmount();</span><br><span class="line">    log.info(<span class="string">&quot;收到下单请求,用户:&#123;&#125;, 商品:&#123;&#125;,数量:&#123;&#125;&quot;</span>, userId, productId, amount);</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">    Order order = Order.builder()</span><br><span class="line">        .userId(userId)</span><br><span class="line">        .productId(productId)</span><br><span class="line">        .status(OrderStatus.INIT)</span><br><span class="line">        .amount(amount)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line">    orderDao.insert(order);</span><br><span class="line">    log.info(<span class="string">&quot;订单一阶段生成，等待扣库存付款中&quot;</span>);</span><br><span class="line">    <span class="comment">// 扣减库存并计算总价</span></span><br><span class="line">    Double totalPrice = productService.reduceStock(productId, amount);</span><br><span class="line">    <span class="comment">// 扣减余额</span></span><br><span class="line">    accountService.reduceBalance(userId, totalPrice);</span><br><span class="line"></span><br><span class="line">    order.setStatus(OrderStatus.SUCCESS);</span><br><span class="line">    order.setTotalPrice(totalPrice);</span><br><span class="line">    orderDao.updateById(order);</span><br><span class="line">    log.info(<span class="string">&quot;订单已成功下单&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;=============ORDER END=================&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>商品服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> ProductDao productDao;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 事务传播特性设置为 REQUIRES_NEW 开启新的事务  重要！！！！一定要使用REQUIRES_NEW</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@DS(&quot;product&quot;)</span></span><br><span class="line">  <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Double <span class="title">reduceStock</span><span class="params">(Long productId, Integer amount)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;=============PRODUCT START=================&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查库存</span></span><br><span class="line">    Product product = productDao.selectById(productId);</span><br><span class="line">    Integer stock = product.getStock();</span><br><span class="line">    log.info(<span class="string">&quot;商品编号为 &#123;&#125; 的库存为&#123;&#125;,订单商品数量为&#123;&#125;&quot;</span>, productId, stock, amount);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (stock &lt; amount) &#123;</span><br><span class="line">      log.warn(<span class="string">&quot;商品编号为&#123;&#125; 库存不足，当前库存:&#123;&#125;&quot;</span>, productId, stock);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;库存不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;开始扣减商品编号为 &#123;&#125; 库存,单价商品价格为&#123;&#125;&quot;</span>, productId, product.getPrice());</span><br><span class="line">    <span class="comment">// 扣减库存</span></span><br><span class="line">    <span class="keyword">int</span> currentStock = stock - amount;</span><br><span class="line">    product.setStock(currentStock);</span><br><span class="line">    productDao.updateById(product);</span><br><span class="line">    <span class="keyword">double</span> totalPrice = product.getPrice() * amount;</span><br><span class="line">    log.info(<span class="string">&quot;扣减商品编号为 &#123;&#125; 库存成功,扣减后库存为&#123;&#125;, &#123;&#125; 件商品总价为 &#123;&#125; &quot;</span>, productId, currentStock, amount, totalPrice);</span><br><span class="line">    log.info(<span class="string">&quot;=============PRODUCT END=================&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> totalPrice;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户服务</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Resource</span></span><br><span class="line">  <span class="keyword">private</span> AccountDao accountDao;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 事务传播特性设置为 REQUIRES_NEW 开启新的事务    重要！！！！一定要使用REQUIRES_NEW</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@DS(&quot;account&quot;)</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceBalance</span><span class="params">(Long userId, Double price)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;=============ACCOUNT START=================&quot;</span>);</span><br><span class="line">    log.info(<span class="string">&quot;当前 XID: &#123;&#125;&quot;</span>, RootContext.getXID());</span><br><span class="line"></span><br><span class="line">    Account account = accountDao.selectById(userId);</span><br><span class="line">    Double balance = account.getBalance();</span><br><span class="line">    log.info(<span class="string">&quot;下单用户&#123;&#125;余额为 &#123;&#125;,商品总价为&#123;&#125;&quot;</span>, userId, balance, price);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (balance &lt; price) &#123;</span><br><span class="line">      log.warn(<span class="string">&quot;用户 &#123;&#125; 余额不足，当前余额:&#123;&#125;&quot;</span>, userId, balance);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;余额不足&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    log.info(<span class="string">&quot;开始扣减用户 &#123;&#125; 余额&quot;</span>, userId);</span><br><span class="line">    <span class="keyword">double</span> currentBalance = account.getBalance() - price;</span><br><span class="line">    account.setBalance(currentBalance);</span><br><span class="line">    accountDao.updateById(account);</span><br><span class="line">    log.info(<span class="string">&quot;扣减用户 &#123;&#125; 余额成功,扣减后用户账户余额为&#123;&#125;&quot;</span>, userId, currentBalance);</span><br><span class="line">    log.info(<span class="string">&quot;=============ACCOUNT END=================&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>在schema自动执行的脚本里，默认设置了商品价格为10，商品总数量为20，用户余额为50。</p>
<p>启动项目后通过命令行执行。</p>
<ol>
<li>模拟正常下单，买一个商品。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http:<span class="comment">//localhost:8080/order/placeOrder \</span></span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;productId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;amount&quot;: 1</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>模拟库存不足，事务回滚。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http:<span class="comment">//localhost:8080/order/placeOrder \</span></span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;productId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;amount&quot;: 22</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>模拟用户余额不足，事务回滚。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">curl -X POST \</span><br><span class="line">  http:<span class="comment">//localhost:8080/order/placeOrder \</span></span><br><span class="line">  -H <span class="string">&#x27;Content-Type: application/json&#x27;</span> \</span><br><span class="line">  -d <span class="string">&#x27;&#123;</span></span><br><span class="line"><span class="string">    &quot;userId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;productId&quot;: 1,</span></span><br><span class="line"><span class="string">    &quot;amount&quot;: 6</span></span><br><span class="line"><span class="string">&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>注意观察运行日志，至此分布式事务集成案例全流程完毕。</p>
<h2 id="事务常见问题"><a href="#事务常见问题" class="headerlink" title="事务常见问题"></a>事务常见问题</h2><p>建议先阅读基础知识。</p>
<p>核心知识： <strong>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</strong><br>核心知识： <strong>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</strong><br>核心知识： <strong>spring原生事务会保证在事务下整个线程后续拿到的都是同一个connection。</strong></p>
<h3 id="原生Spring-Transational能和-DS一起使用吗？"><a href="#原生Spring-Transational能和-DS一起使用吗？" class="headerlink" title="原生Spring@Transational能和@DS一起使用吗？"></a>原生Spring<code>@Transational</code>能和<code>@DS</code>一起使用吗？</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;a&quot;)</span></span><br><span class="line">    <span class="meta">@Transational</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//some code</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以的，其会先切换使用数据源a再开启事务，整个原生事务内部不管是注解切换还是手动调用代码切换都不能切换，会一直使用a数据源。</p>
<p>所以确认整个事务下不再切换其他数据源，用原生 <code>@Transational</code> 是建议的，毕竟其更完善。</p>
<h3 id="本地事务和Spring原生事务不能混用是什么意思？"><a href="#本地事务和Spring原生事务不能混用是什么意思？" class="headerlink" title="本地事务和Spring原生事务不能混用是什么意思？"></a>本地事务和Spring原生事务不能混用是什么意思？</h3><p>场景一：先使用的Spring<code>@Transational</code> 内部方法调用了本地<code>@DSTransactional</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;a&quot;)</span></span><br><span class="line">    <span class="meta">@Transational</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Bservice.dosomething(); <span class="comment">//B是另外数据源，然后注解了@DS(&quot;b&quot;)和@DSTransactional</span></span><br><span class="line">        Cservice.dosomething(); <span class="comment">//C是另外数据源，然后注解了@DS(&quot;c&quot;)和@DSTransactional</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>基于核心知识： 整理事务下都是a数据源，内部无论做什么都改变不了使用a数据源。</p>
<p>场景二： 先使用的本地<code>@DSTransactional</code>内部方法调用了Spring<code>@Transational</code> 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;a&quot;)</span></span><br><span class="line">    <span class="meta">@DSTransactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Amapper.updateSomeThing();</span><br><span class="line">        Bservice.dosomething(); <span class="comment">//B是另外数据源，然后注解了@DS(&quot;b&quot;)和@Transational</span></span><br><span class="line">        Cservice.dosomething(); <span class="comment">//C是另外数据源，然后注解了@DS(&quot;b&quot;)和@Transational</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>B和C都是独立的事务。C发生错误B会回滚吗？不会B已经提交了。A会回滚吗？会。</p>
<p>不建议混用，除非你确实非常理解事务，能随心所欲掌握你代码的执行流程。</p>
<h3 id="本地事务标准使用。"><a href="#本地事务标准使用。" class="headerlink" title="本地事务标准使用。"></a>本地事务标准使用。</h3><p>请结合阅读本地事务章节。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@DS(&quot;a&quot;)</span></span><br><span class="line">    <span class="meta">@DSTransactional</span><span class="comment">//最外层开启即可</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dosomething</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Amapper.updateSomeThing();</span><br><span class="line">        Bservice.dosomething(); <span class="comment">//B是另外数据源，然后注解了@DS(&quot;b&quot;)</span></span><br><span class="line">        Cservice.dosomething(); <span class="comment">//C是另外数据源，然后注解了@DS(&quot;b&quot;)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="调试源码"><a href="#调试源码" class="headerlink" title="调试源码"></a>调试源码</h1><ol>
<li>开启动态数据源的debug日志。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">logging:</span><br><span class="line">  level:</span><br><span class="line">    com.baomidou.dynamic: debug</span><br></pre></td></tr></table></figure>

<p>检查日志输出是否正确。</p>
<ol>
<li>断点调试DynamicDataSourceAnnotationInterceptor。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicDataSourceAnnotationInterceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DYNAMIC_PREFIX = <span class="string">&quot;#&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSourceClassResolver dataSourceClassResolver;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DsProcessor dsProcessor;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DynamicDataSourceAnnotationInterceptor</span><span class="params">(Boolean allowedPublicOnly, DsProcessor dsProcessor)</span> </span>&#123;</span><br><span class="line">        dataSourceClassResolver = <span class="keyword">new</span> DataSourceClassResolver(allowedPublicOnly);</span><br><span class="line">        <span class="keyword">this</span>.dsProcessor = dsProcessor;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//这里把获取到的数据源标识如master存入本地线程</span></span><br><span class="line">            String dsKey = determineDatasourceKey(invocation);</span><br><span class="line">        ●  DynamicDataSourceContextHolder.push(dsKey);</span><br><span class="line">            <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            DynamicDataSourceContextHolder.poll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">determineDatasourceKey</span><span class="params">(MethodInvocation invocation)</span> </span>&#123;</span><br><span class="line">        String key = dataSourceClassResolver.findDSKey(invocation.getMethod(), invocation.getThis());</span><br><span class="line">        <span class="keyword">return</span> (!key.isEmpty() &amp;&amp; key.startsWith(DYNAMIC_PREFIX)) ? dsProcessor.determineDatasource(invocation, key) : key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>断点调试DynamicRoutingDataSource。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicRoutingDataSource</span> <span class="keyword">extends</span> <span class="title">AbstractRoutingDataSource</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DataSource&gt; dataSourceMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, DynamicGroupDataSource&gt; groupDataSources = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">determineDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//从本地线程获取key解析最终真实的数据源</span></span><br><span class="line">     ●  String dsKey = DynamicDataSourceContextHolder.peek();</span><br><span class="line">        <span class="keyword">return</span> getDataSource(dsKey);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> DataSource <span class="title">determinePrimaryDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">&quot;从默认数据源中返回数据&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> groupDataSources.containsKey(primary) ? groupDataSources.get(primary).determineDataSource() : dataSourceMap.get(primary);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">getDataSource</span><span class="params">(String ds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(ds)) &#123;</span><br><span class="line">            <span class="keyword">return</span> determinePrimaryDataSource();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!groupDataSources.isEmpty() &amp;&amp; groupDataSources.containsKey(ds)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;从 &#123;&#125; 组数据源中返回数据源&quot;</span>, ds);</span><br><span class="line">            <span class="keyword">return</span> groupDataSources.get(ds).determineDataSource();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataSourceMap.containsKey(ds)) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;从 &#123;&#125; 单数据源中返回数据源&quot;</span>, ds);</span><br><span class="line">            <span class="keyword">return</span> dataSourceMap.get(ds);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> determinePrimaryDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="切换数据源失败"><a href="#切换数据源失败" class="headerlink" title="切换数据源失败"></a>切换数据源失败</h1><ul>
<li><h2 id="1-开启了spring的事务。"><a href="#1-开启了spring的事务。" class="headerlink" title="1.开启了spring的事务。"></a>1.开启了spring的事务。</h2></li>
</ul>
<p>原因： spring开启事务后会维护一个ConnectionHolder，保证在整个事务下，都是用同一个数据库连接。</p>
<p>请检查整个调用链路涉及的类的方法和类本身还有继承的抽象类上是否有<code>@Transactional</code>注解。</p>
<p>如强烈需要事务保证多个库同时执行成功或者失败，请查看事务专栏的解决办法。</p>
<h2 id="2-方法内部调用。"><a href="#2-方法内部调用。" class="headerlink" title="2.方法内部调用。"></a>2.方法内部调用。</h2><p>查看以下示例 回答 外部调用 <code>userservice.test1()</code> 能在执行到 <code>test2()</code> 切换到second数据源吗？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> UserService &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;first&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">         test2();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;second&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// do something</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>答案：<strong>！！！不能不能不能！！！！</strong> 数据源核心原理是基于aop代理实现切换，内部方法调用不会使用aop。</p>
<p>解决方法:</p>
<p>把test2()方法提到另外一个service,单独调用。</p>
<h2 id="3-shiroAop代理。"><a href="#3-shiroAop代理。" class="headerlink" title="3.shiroAop代理。"></a>3.shiroAop代理。</h2><p>在shiro框架中(UserRealm)使用@Autowire 注入的类, 缓存注解和事务注解都失效。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lazy</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> IUserService userService;</span><br><span class="line">	<span class="comment">//... 省略其他无关的内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决方法:<br>1.在Shiro框架中注入Bean时, 不使用@Autowire, 使用ApplicationContextRegister.getBean()方法,手动注入bean。</p>
<p>2.使用@Autowire+@Lazy注解,设置注入到Shiro框架的Bean延时加载(推荐)。</p>
<h2 id="4-PostConstruct初始化顺序。"><a href="#4-PostConstruct初始化顺序。" class="headerlink" title="4.PostConstruct初始化顺序。"></a>4.PostConstruct初始化顺序。</h2><p>初始化包括: @PostConstruct 注解, InitializingBean接口, 自定义init-method</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@DS(&quot;slave&quot;)</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 无法选择正确的数据源</span></span><br><span class="line">        userMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决方法：监听容器启动完成事件, 在容器完成后做初始化。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DS(&quot;slave&quot;)</span></span><br><span class="line">    <span class="meta">@EventListener</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 成功选择正确的数据源</span></span><br><span class="line">        userMapper.selectById(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相关spring源码 : `org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory#initializeBean</p>
<p>在初始化完成后, bean 进入增强阶段, 所以这个阶段的任何AOP都是无效的。</p>
<h2 id="5-Druid版本过低。"><a href="#5-Druid版本过低。" class="headerlink" title="5.Druid版本过低。"></a>5.Druid版本过低。</h2><p>请升级druid1.1.22及以上版本，这个版本修复了在高并发下偶发的切换失效问题。</p>
<h2 id="6-Async或者java8的ParallelStream并行流之类方法。"><a href="#6-Async或者java8的ParallelStream并行流之类方法。" class="headerlink" title="6.@Async或者java8的ParallelStream并行流之类方法。"></a>6.@Async或者java8的ParallelStream并行流之类方法。</h2><p>这种情况都是新开了线程去处理，不受当前线程管控了。 可以在新开的方法上加对应的DS注解解决。</p>
<hr>
<h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><h3 id="shiro失效原因"><a href="#shiro失效原因" class="headerlink" title="shiro失效原因"></a>shiro失效原因</h3><p>在spring初始化bean的阶段中,大致上分为三段: BeanFactoryPostProcessor -&gt; BeanPostProcessor -&gt; Bean</p>
<p>这三种都是单例bean. 只不过会按照这个优先级进行初始化, shiro引起AOP失效的原因:</p>
<p>ShiroFilterFactoryBean 是一个 BeanPostProcessor , 比普通的单例Bean都优先加载, 所以他依赖注入的bean都无法正确的进行切面。</p>
<p>ShiroFilterFactoryBean 实际的依赖情况:<br>ShiroFilterFactoryBean -&gt; SecurityManager -&gt; UserRealm -&gt; IUserService</p>
<p>IUserService依赖的其他 service 也会失效<br>IUserService-&gt; MenuService -&gt; RoleService</p>
<h1 id="辅助知识"><a href="#辅助知识" class="headerlink" title="辅助知识"></a>辅助知识</h1><h2 id="如何注入多数据源？"><a href="#如何注入多数据源？" class="headerlink" title="如何注入多数据源？"></a>如何注入多数据源？</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> dosomething&#123;</span><br><span class="line">         <span class="comment">//使用的时候需要强转</span></span><br><span class="line">        DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何获取当前线程数据源名称？"><a href="#如何获取当前线程数据源名称？" class="headerlink" title="如何获取当前线程数据源名称？"></a>如何获取当前线程数据源名称？</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DynamicDataSourceContextHolder.peek()</span><br></pre></td></tr></table></figure>

<h2 id="如何获取当前线程数据源？"><a href="#如何获取当前线程数据源？" class="headerlink" title="如何获取当前线程数据源？"></a>如何获取当前线程数据源？</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> dosomething&#123;</span><br><span class="line">    DynamicRoutingDataSource ds = (DynamicRoutingDataSource) dataSource;</span><br><span class="line">    DataSource datasource=ds.determineDataSource();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DynamicRoutingDataSource-其他常用方法"><a href="#DynamicRoutingDataSource-其他常用方法" class="headerlink" title="DynamicRoutingDataSource 其他常用方法"></a>DynamicRoutingDataSource 其他常用方法</h2><p><img src="https://img.kancloud.cn/f6/29/f6299c3dfee04ee56b8db1a276a8004e_502x190.png" alt="img"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">流年</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://www.yafeiz.com/2021/07/30/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/">http://www.yafeiz.com/2021/07/30/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://www.yafeiz.com" target="_blank">锦瑟流年</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><div class="post_share"><div class="social-share" data-image="/img/index.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/08/02/WMS%EF%BC%88%E4%BB%93%E5%BA%93%EF%BC%89%E7%B3%BB%E7%BB%9F/"><img class="prev-cover" src="/img/index.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">WMS（仓库）系统</div></div></a></div><div class="next-post pull-right"><a href="/2021/07/14/%E5%BC%82%E6%AD%A5%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7-FlinkX/"><img class="next-cover" src="/img/index.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">异步数据同步工具-FlinkX</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2020/12/09/javaWeb接口文档/" title="javaWeb接口文档"><img class="cover" src="/img/index.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-09</div><div class="title">javaWeb接口文档</div></div></a></div><div><a href="/2021/01/09/yShop环境部署/" title="yShop环境部署"><img class="cover" src="/img/index.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-01-09</div><div class="title">yShop环境部署</div></div></a></div><div><a href="/2020/12/08/Java高效率代码/" title="Java高效率代码"><img class="cover" src="/img/index.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-12-08</div><div class="title">Java高效率代码</div></div></a></div><div><a href="/2021/08/02/javaweb项目输出日志到RabbitMQ/" title="javaweb项目输出日志到RabbitMQ"><img class="cover" src="/img/index.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-02</div><div class="title">javaweb项目输出日志到RabbitMQ</div></div></a></div><div><a href="/2021/08/02/RestTemplate请求工具类/" title="RestTemplate请求工具类"><img class="cover" src="/img/index.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-02</div><div class="title">RestTemplate请求工具类</div></div></a></div></div></div></div><div class="aside_content" id="aside_content"><div class="card-widget card-info"><div class="card-content"><div class="card-info-avatar is-center"><img class="avatar-img" src="/null" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">流年</div><div class="author-info__description">锦瑟流年</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn"><i></i><span></span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/1361220256@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="card-content"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%A6%E5%AE%9A"><span class="toc-number">1.3.</span> <span class="toc-text">约定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.</span> <span class="toc-text">使用方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E9%9B%86%E6%88%90"><span class="toc-number">2.</span> <span class="toc-text">连接池集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E5%BF%85%E8%AF%BB"><span class="toc-number">2.1.</span> <span class="toc-text">连接池必读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Druid"><span class="toc-number">2.2.</span> <span class="toc-text">集成Druid</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.2.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-druid-spring-boot-starter-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">1. 项目引入 druid-spring-boot-starter 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%8E%92%E9%99%A4%E5%8E%9F%E7%94%9FDruid%E7%9A%84%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E7%B1%BB%E3%80%82"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">2. 排除原生Druid的快速配置类。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">3.参数配置。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81"><span class="toc-number">2.2.3.</span> <span class="toc-text">核心源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90HikariCP"><span class="toc-number">2.3.</span> <span class="toc-text">集成HikariCP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">2.3.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4-1"><span class="toc-number">2.3.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-HikariCP-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">1. 项目引入 HikariCP 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">2.参数配置。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">2.3.3.</span> <span class="toc-text">常见问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81-1"><span class="toc-number">2.3.4.</span> <span class="toc-text">核心源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90BeeCP"><span class="toc-number">2.4.</span> <span class="toc-text">集成BeeCP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-2"><span class="toc-number">2.4.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4-2"><span class="toc-number">2.4.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-BeeCp-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">1. 项目引入 BeeCp 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E3%80%82-1"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">2.参数配置。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81-2"><span class="toc-number">2.4.3.</span> <span class="toc-text">核心源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90DBCP2"><span class="toc-number">2.5.</span> <span class="toc-text">集成DBCP2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-3"><span class="toc-number">2.5.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4-3"><span class="toc-number">2.5.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-Dbcp2-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">1. 项目引入 Dbcp2 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE%E3%80%82-2"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">2.参数配置。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81-3"><span class="toc-number">2.5.3.</span> <span class="toc-text">核心源码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Jndi"><span class="toc-number">2.6.</span> <span class="toc-text">集成Jndi</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E9%9B%86%E6%88%90"><span class="toc-number">3.</span> <span class="toc-text">第三方集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90MybatisPlus"><span class="toc-number">3.1.</span> <span class="toc-text">集成MybatisPlus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-4"><span class="toc-number">3.1.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4-4"><span class="toc-number">3.1.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-mybatis-Plus-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">1. 项目引入 mybatis-Plus 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E4%BD%BF%E7%94%A8DS%E6%B3%A8%E8%A7%A3%E8%BF%9B%E8%A1%8C%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%E3%80%82"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">2. 使用DS注解进行切换数据源。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%86%E9%A1%B5%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">3.1.2.3.</span> <span class="toc-text">3.分页配置。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%E3%80%82"><span class="toc-number">3.1.2.4.</span> <span class="toc-text">4.注意事项。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FAQ"><span class="toc-number">3.1.3.</span> <span class="toc-text">FAQ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE"><span class="toc-number">3.1.4.</span> <span class="toc-text">示例项目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90P6spy"><span class="toc-number">3.2.</span> <span class="toc-text">集成P6spy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-5"><span class="toc-number">3.2.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E6%88%90%E6%AD%A5%E9%AA%A4-5"><span class="toc-number">3.2.2.</span> <span class="toc-text">集成步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5p6spy%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">1. 项目引入p6spy依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%AF%E7%94%A8p6spy%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E3%80%82"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">2. 启用p6spy相关配置。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%BC%95%E5%85%A5%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E3%80%82"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">3. 引入相关配置文件。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90Quartz"><span class="toc-number">3.3.</span> <span class="toc-text">集成Quartz</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-6"><span class="toc-number">3.3.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-1"><span class="toc-number">3.3.2.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E7%94%A8-quartz-starter-%E3%80%82"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">1. 项目引用 quartz-starter 。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90%E5%8F%82%E6%95%B0%E3%80%82"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">2. 配置数据源参数。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E4%BB%BB%E5%8A%A1%E3%80%82"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">3. 创建任务。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AEQuartz%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E6%BA%90%E3%80%82"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">4 配置Quartz实际使用的数据源。</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#4-1-%E6%96%B9%E5%BC%8F%E4%B8%80%EF%BC%9A-%E8%87%AA%E5%AE%9A%E4%B9%89SchedulerFactoryBeanCustomizer%E3%80%82"><span class="toc-number">3.3.2.4.1.</span> <span class="toc-text">4.1 方式一： 自定义SchedulerFactoryBeanCustomizer。</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-2-%E6%96%B9%E5%BC%8F%E4%BA%8C%EF%BC%9A-%E4%BD%BF%E7%94%A8-QuartzDataSource%E6%9D%A5%E6%8C%87%E6%98%8Equartz%E6%95%B0%E6%8D%AE%E6%BA%90%E3%80%82"><span class="toc-number">3.3.2.4.2.</span> <span class="toc-text">4.2 方式二： 使用@QuartzDataSource来指明quartz数据源。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE-1"><span class="toc-number">3.3.3.</span> <span class="toc-text">示例项目</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E6%88%90ShardingJdbc"><span class="toc-number">3.4.</span> <span class="toc-text">集成ShardingJdbc</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-7"><span class="toc-number">3.4.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-2"><span class="toc-number">3.4.2.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%A1%B9%E7%9B%AE%E5%BC%95%E5%85%A5-shardingsphere-%E4%BE%9D%E8%B5%96%E3%80%82"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">1. 项目引入 shardingsphere 依赖。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%88%86%E5%88%AB%E9%85%8D%E7%BD%AEshardingjdbc%E5%92%8C%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E3%80%82"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">2. 分别配置shardingjdbc和多数据源。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%80%9A%E8%BF%87%E8%87%AA%E5%AE%9A%E4%B9%89DynamicDataSourceProvider%E5%AE%8C%E6%88%90%E4%B8%8Eshardingsphere%E7%9A%84%E9%9B%86%E6%88%90%E3%80%82"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">3. 通过自定义DynamicDataSourceProvider完成与shardingsphere的集成。</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE-2"><span class="toc-number">3.4.3.</span> <span class="toc-text">示例项目</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">进阶使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0%E7%A7%BB%E9%99%A4%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.1.</span> <span class="toc-text">动态添加移除数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-8"><span class="toc-number">4.1.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%AD%A5%E9%AA%A4"><span class="toc-number">4.1.2.</span> <span class="toc-text">使用步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE-3"><span class="toc-number">4.1.3.</span> <span class="toc-text">示例项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.1.4.</span> <span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%A7%A3%E6%9E%90%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.2.</span> <span class="toc-text">动态解析数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-9"><span class="toc-number">4.2.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%89%A9%E5%B1%95"><span class="toc-number">4.2.2.</span> <span class="toc-text">如何扩展?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E5%A4%84%E7%90%86%E5%99%A8%E3%80%82"><span class="toc-number">4.2.2.1.</span> <span class="toc-text">1. 自定义一个处理器。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%87%8D%E5%86%99%E5%AE%8C%E5%90%8E%E9%87%8D%E6%96%B0%E6%B3%A8%E5%85%A5%E4%B8%80%E4%B8%AA%E6%A0%B9%E6%8D%AE%E8%87%AA%E5%B7%B1%E8%A7%A3%E6%9E%90%E9%A1%BA%E5%BA%8F%E7%9A%84%E8%A7%A3%E6%9E%90%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">4.2.2.2.</span> <span class="toc-text">2. 重写完后重新注入一个根据自己解析顺序的解析处理器.</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F"><span class="toc-number">4.2.3.</span> <span class="toc-text">注意</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%8A%A0%E5%AF%86"><span class="toc-number">4.3.</span> <span class="toc-text">数据库加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-10"><span class="toc-number">4.3.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%BD%BF%E7%94%A8"><span class="toc-number">4.3.2.</span> <span class="toc-text">具体使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%8E%B7%E5%BE%97%E5%8A%A0%E5%AF%86%E5%AD%97%E7%AC%A6%E4%B8%B2%E3%80%82"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">1. 获得加密字符串。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E9%85%8D%E7%BD%AE%E5%8A%A0%E5%AF%86yml%E3%80%82"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">2. 配置加密yml。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC"><span class="toc-number">4.4.</span> <span class="toc-text">启动初始化执行脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%89%A7%E8%A1%8C%E8%84%9A%E6%9C%AC-1"><span class="toc-number">4.4.1.</span> <span class="toc-text">启动初始化执行脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%87%92%E5%90%AF%E5%8A%A8%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.5.</span> <span class="toc-text">懒启动数据源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-11"><span class="toc-number">4.5.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8"><span class="toc-number">4.5.2.</span> <span class="toc-text">配置使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%95%B0%E6%8D%AE%E6%BA%90%E5%90%AF%E5%8A%A8"><span class="toc-number">4.6.</span> <span class="toc-text">无数据源启动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-12"><span class="toc-number">4.6.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="toc-number">4.6.2.</span> <span class="toc-text">配置方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.7.</span> <span class="toc-text">手动切换数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%B3%A8%E5%85%A5%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">4.8.</span> <span class="toc-text">手动注入多数据源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">5.</span> <span class="toc-text">自定义</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%B3%A8%E8%A7%A3"><span class="toc-number">5.1.</span> <span class="toc-text">自定义注解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-13"><span class="toc-number">5.1.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-3"><span class="toc-number">5.1.2.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E9%9C%80%E8%A6%81%E8%87%AA%E5%B7%B1%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E6%B3%A8%E8%A7%A3%E5%B9%B6%E7%BB%A7%E6%89%BF%E8%87%AADS%E3%80%82"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">1. 需要自己定义一个注解并继承自DS。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E6%B3%A8%E8%A7%A3%E5%9C%A8%E9%9C%80%E8%A6%81%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%E7%9A%84%E6%96%B9%E6%B3%95%E4%B8%8A%E6%88%96%E7%B1%BB%E4%B8%8A%E3%80%82"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">2. 注解在需要切换数据源的方法上或类上。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90%E6%9D%A5%E6%BA%90"><span class="toc-number">5.2.</span> <span class="toc-text">自定义数据源来源</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E6%BA%90%E6%9D%A5%E6%BA%90-1"><span class="toc-number">5.2.1.</span> <span class="toc-text">自定义数据源来源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-14"><span class="toc-number">5.2.2.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.2.3.</span> <span class="toc-text">自定义示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.</span> <span class="toc-text">自定义负载均衡策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5-1"><span class="toc-number">5.3.1.</span> <span class="toc-text">自定义负载均衡策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-15"><span class="toc-number">5.3.2.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%87%AA%E5%AE%9A%E4%B9%89"><span class="toc-number">5.3.3.</span> <span class="toc-text">如何自定义</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E6%B3%A8%E8%A7%A3%E6%96%B9%E6%A1%88"><span class="toc-number">6.</span> <span class="toc-text">无注解方案</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E6%B3%A8%E8%A7%A3%E5%BF%85%E8%AF%BB"><span class="toc-number">6.1.</span> <span class="toc-text">无注解必读</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#filter%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">6.2.</span> <span class="toc-text">filter切换数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#intercepror%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="toc-number">6.3.</span> <span class="toc-text">intercepror切换数据源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%87%E9%9D%A2"><span class="toc-number">6.4.</span> <span class="toc-text">自定义切面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mybatis%E4%B8%8B%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">6.5.</span> <span class="toc-text">mybatis下读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">6.5.1.</span> <span class="toc-text">自动读写分离</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%B8%93%E6%A0%8F"><span class="toc-number">7.</span> <span class="toc-text">事务专栏</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E6%A6%82%E5%BF%B5"><span class="toc-number">7.1.</span> <span class="toc-text">事务概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8B%E5%8A%A1%EF%BC%9F"><span class="toc-number">7.1.1.</span> <span class="toc-text">什么是事务？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9FJDBC%E5%A4%84%E7%90%86%E4%BA%8B%E5%8A%A1%E3%80%82"><span class="toc-number">7.1.2.</span> <span class="toc-text">原生JDBC处理事务。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Spring%E5%A4%84%E7%90%86%E4%BA%8B%E5%8A%A1%E3%80%82"><span class="toc-number">7.1.3.</span> <span class="toc-text">Spring处理事务。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="toc-number">7.2.</span> <span class="toc-text">基础知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86-1"><span class="toc-number">7.2.1.</span> <span class="toc-text">基础知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E4%BD%BF%E7%94%A8%E4%BA%86%E4%BA%8B%E5%8A%A1%E5%A6%82-Transational-%E6%97%A0%E6%B3%95%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9F"><span class="toc-number">7.2.2.</span> <span class="toc-text">问：使用了事务如@Transational 无法切换数据源？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%BF%E7%94%A8%E4%BA%86%E4%BA%8B%E5%8A%A1%E5%A6%82-Transational%E5%B0%B1%E6%97%A0%E6%B3%95%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9F"><span class="toc-number">7.2.3.</span> <span class="toc-text">问：为什么使用了事务如@Transational就无法切换数据源？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E4%BA%8B%E5%8A%A1%E4%B8%8B%E6%97%A0%E6%B3%95%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%E6%88%91%E7%9F%A5%E9%81%93%E4%BA%86%EF%BC%8C%E9%82%A3%E6%88%91%E5%8D%95%E5%BA%93%E7%9A%84%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%8F%AF%E4%BB%A5%E7%94%A8%E5%90%97%EF%BC%9F"><span class="toc-number">7.2.4.</span> <span class="toc-text">问：事务下无法切换数据源我知道了，那我单库的事务的可以用吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%EF%BC%9A%E6%88%91%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%BF%85%E9%A1%BB%E8%A6%81%E4%BF%9D%E8%AF%81%E4%BA%8B%E5%8A%A1%EF%BC%8C%E8%BF%98%E6%9C%89%E4%BB%80%E4%B9%88%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95%EF%BC%9F"><span class="toc-number">7.2.5.</span> <span class="toc-text">问：我的业务必须要保证事务，还有什么解决办法？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%98%E6%9C%89%E6%B2%A1%E6%9C%89%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88%EF%BC%9F"><span class="toc-number">7.2.6.</span> <span class="toc-text">还有没有其他方案？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1"><span class="toc-number">7.3.</span> <span class="toc-text">本地事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E6%99%AF"><span class="toc-number">7.3.1.</span> <span class="toc-text">背景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-16"><span class="toc-number">7.3.2.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">7.3.3.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-4"><span class="toc-number">7.3.4.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE-4"><span class="toc-number">7.3.5.</span> <span class="toc-text">示例项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.3.6.</span> <span class="toc-text">原理介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#seata%E4%BA%8B%E5%8A%A1"><span class="toc-number">7.4.</span> <span class="toc-text">seata事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D-17"><span class="toc-number">7.4.1.</span> <span class="toc-text">基础介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9-1"><span class="toc-number">7.4.2.</span> <span class="toc-text">注意事项</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E9%A1%B9%E7%9B%AE-5"><span class="toc-number">7.4.3.</span> <span class="toc-text">示例项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">7.4.4.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E5%87%86%E5%A4%87"><span class="toc-number">7.4.5.</span> <span class="toc-text">工程准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%BC%96%E5%86%99"><span class="toc-number">7.4.6.</span> <span class="toc-text">代码编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">7.4.7.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"><span class="toc-number">7.5.</span> <span class="toc-text">事务常见问题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%94%9FSpring-Transational%E8%83%BD%E5%92%8C-DS%E4%B8%80%E8%B5%B7%E4%BD%BF%E7%94%A8%E5%90%97%EF%BC%9F"><span class="toc-number">7.5.1.</span> <span class="toc-text">原生Spring@Transational能和@DS一起使用吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E5%92%8CSpring%E5%8E%9F%E7%94%9F%E4%BA%8B%E5%8A%A1%E4%B8%8D%E8%83%BD%E6%B7%B7%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%E6%84%8F%E6%80%9D%EF%BC%9F"><span class="toc-number">7.5.2.</span> <span class="toc-text">本地事务和Spring原生事务不能混用是什么意思？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E4%BA%8B%E5%8A%A1%E6%A0%87%E5%87%86%E4%BD%BF%E7%94%A8%E3%80%82"><span class="toc-number">7.5.3.</span> <span class="toc-text">本地事务标准使用。</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E6%BA%90%E7%A0%81"><span class="toc-number">8.</span> <span class="toc-text">调试源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%87%E6%8D%A2%E6%95%B0%E6%8D%AE%E6%BA%90%E5%A4%B1%E8%B4%A5"><span class="toc-number">9.</span> <span class="toc-text">切换数据源失败</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%BC%80%E5%90%AF%E4%BA%86spring%E7%9A%84%E4%BA%8B%E5%8A%A1%E3%80%82"><span class="toc-number">9.1.</span> <span class="toc-text">1.开启了spring的事务。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%B9%E6%B3%95%E5%86%85%E9%83%A8%E8%B0%83%E7%94%A8%E3%80%82"><span class="toc-number">9.2.</span> <span class="toc-text">2.方法内部调用。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-shiroAop%E4%BB%A3%E7%90%86%E3%80%82"><span class="toc-number">9.3.</span> <span class="toc-text">3.shiroAop代理。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-PostConstruct%E5%88%9D%E5%A7%8B%E5%8C%96%E9%A1%BA%E5%BA%8F%E3%80%82"><span class="toc-number">9.4.</span> <span class="toc-text">4.PostConstruct初始化顺序。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Druid%E7%89%88%E6%9C%AC%E8%BF%87%E4%BD%8E%E3%80%82"><span class="toc-number">9.5.</span> <span class="toc-text">5.Druid版本过低。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Async%E6%88%96%E8%80%85java8%E7%9A%84ParallelStream%E5%B9%B6%E8%A1%8C%E6%B5%81%E4%B9%8B%E7%B1%BB%E6%96%B9%E6%B3%95%E3%80%82"><span class="toc-number">9.6.</span> <span class="toc-text">6.@Async或者java8的ParallelStream并行流之类方法。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E9%98%85%E8%AF%BB"><span class="toc-number">9.7.</span> <span class="toc-text">扩展阅读</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro%E5%A4%B1%E6%95%88%E5%8E%9F%E5%9B%A0"><span class="toc-number">9.7.1.</span> <span class="toc-text">shiro失效原因</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BE%85%E5%8A%A9%E7%9F%A5%E8%AF%86"><span class="toc-number">10.</span> <span class="toc-text">辅助知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%B3%A8%E5%85%A5%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9F"><span class="toc-number">10.1.</span> <span class="toc-text">如何注入多数据源？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%E5%90%8D%E7%A7%B0%EF%BC%9F"><span class="toc-number">10.2.</span> <span class="toc-text">如何获取当前线程数据源名称？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%BA%BF%E7%A8%8B%E6%95%B0%E6%8D%AE%E6%BA%90%EF%BC%9F"><span class="toc-number">10.3.</span> <span class="toc-text">如何获取当前线程数据源？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DynamicRoutingDataSource-%E5%85%B6%E4%BB%96%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">10.4.</span> <span class="toc-text">DynamicRoutingDataSource 其他常用方法</span></a></li></ol></li></ol></div></div></div><div class="card-widget card-recent-post"><div class="card-content"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/13/%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E6%B3%B5%E5%AF%BC%E5%85%A5-%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE/" title="Oracle11g使用数据泵导入/导出数据">Oracle11g使用数据泵导入/导出数据</a><time datetime="2021-08-13T13:37:17.000Z" title="发表于 2021-08-13 21:37:17">2021-08-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/09/%E7%BB%8F%E5%85%B8%E8%AF%AD%E5%BD%95%EF%BC%88%E4%B8%89%EF%BC%89/" title="经典语录（三）">经典语录（三）</a><time datetime="2021-08-09T11:22:10.000Z" title="发表于 2021-08-09 19:22:10">2021-08-09</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/02/RestTemplate%E8%AF%B7%E6%B1%82%E5%B7%A5%E5%85%B7%E7%B1%BB/" title="RestTemplate请求工具类">RestTemplate请求工具类</a><time datetime="2021-08-02T14:00:18.000Z" title="发表于 2021-08-02 22:00:18">2021-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/02/javaweb%E9%A1%B9%E7%9B%AE%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97%E5%88%B0RabbitMQ/" title="javaweb项目输出日志到RabbitMQ">javaweb项目输出日志到RabbitMQ</a><time datetime="2021-08-02T13:49:55.000Z" title="发表于 2021-08-02 21:49:55">2021-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2021/08/02/WMS%EF%BC%88%E4%BB%93%E5%BA%93%EF%BC%89%E7%B3%BB%E7%BB%9F/" title="WMS（仓库）系统">WMS（仓库）系统</a><time datetime="2021-08-02T13:22:35.000Z" title="发表于 2021-08-02 21:22:35">2021-08-02</time></div></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/index.jpg)"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 流年</div><div class="icp"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/recordQuery"><img class="icp-icon" src="/img/icp.png" alt="ICP"/><span>豫ICP备20002785号-1</span></a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script></div></body></html>